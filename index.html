<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HEVY ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆç™»éŒ²ãƒ„ãƒ¼ãƒ« v6.3ï¼ˆæœªæ¥å¯¾å¿œï¼‰</title>
  <style>
    :root { --bg:#0b0f14; --card:#131a22; --ink:#e6eef7; --muted:#a9b6c6; --acc:#4aa3ff; --danger:#ff5566; --ok:#15c27a; --step-inactive:#1e2a36; --step-active:#4aa3ff; --step-complete:#15c27a; }
    * { box-sizing: border-box; }
    body { margin:0; padding:12px; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif; background: var(--bg); color: var(--ink); max-width: 1200px; margin: 0 auto; }
    h1 { font-size: 1.2rem; margin: 0 0 4px; }
    .subtitle { color: var(--muted); margin-bottom: 12px; font-size: 0.85rem; }
    
    /* ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    .step-indicator { display: flex; justify-content: space-between; margin-bottom: 12px; padding: 0 5px; }
    .step { flex: 1; text-align: center; position: relative; }
    .step:not(:last-child)::after { content: ''; position: absolute; top: 16px; left: 50%; width: 100%; height: 2px; background: var(--step-inactive); z-index: -1; }
    .step.complete:not(:last-child)::after { background: var(--step-complete); }
    .step-circle { width: 28px; height: 28px; border-radius: 50%; background: var(--step-inactive); border: 2px solid var(--step-inactive); color: var(--muted); display: flex; align-items: center; justify-content: center; margin: 0 auto 4px; font-weight: 700; transition: all 0.3s; font-size: 0.8rem; }
    .step.active .step-circle { background: var(--step-active); border-color: var(--step-active); color: #fff; box-shadow: 0 0 20px rgba(74, 163, 255, 0.4); }
    .step.complete .step-circle { background: var(--step-complete); border-color: var(--step-complete); color: #fff; }
    .step.complete .step-circle::before { content: 'âœ“'; }
    .step-label { font-size: 0.7rem; color: var(--muted); }
    .step.active .step-label { color: var(--acc); font-weight: 600; }
    .step.complete .step-label { color: var(--ok); }
    
    /* ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
    .card { background: var(--card); border: 1px solid #1e2a36; border-radius: 8px; padding: 12px; margin-bottom: 8px; }
    .card.collapsed .card-content { display: none; }
    .card-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; margin-bottom: 8px; }
    .card-header h2 { margin: 0; font-size: 0.95rem; display: flex; align-items: center; gap: 6px; }
    .card-header .status-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
    .status-badge.pending { background: #1e2a36; color: var(--muted); }
    .status-badge.complete { background: rgba(21, 194, 122, 0.2); color: var(--ok); border: 1px solid var(--ok); }
    .status-badge.active { background: rgba(74, 163, 255, 0.2); color: var(--acc); border: 1px solid var(--acc); }
    .expand-icon { color: var(--muted); transition: transform 0.3s; }
    .card.collapsed .expand-icon { transform: rotate(180deg); }
    
    /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
    label { font-size: .75rem; color: var(--muted); display:block; margin-bottom: 2px; }
    input[type="text"], input[type="number"], input[type="datetime-local"], textarea { width:100%; padding:6px 8px; border-radius:6px; border:1px solid #263648; background:#0e141b; color:var(--ink); outline:none; transition: border-color 0.3s; font-size: 0.85rem; }
    input:focus, textarea:focus { border-color: var(--acc); }
    input.valid { border-color: var(--ok); }
    textarea { min-height:60px; resize:vertical; }
    .row { display:flex; gap:6px; margin-bottom: 6px; }
    .row > * { flex:1; }
    
    /* ãƒœã‚¿ãƒ³ */
    .btn { appearance:none; border:1px solid #29425c; background:#112132; color:var(--ink); padding:6px 12px; border-radius:6px; cursor:pointer; font-weight:600; transition: all 0.3s; font-size: 0.8rem; }
    .btn:hover { border-color:#3b5f83; transform: translateY(-1px); }
    .btn.primary { background: linear-gradient(180deg, #1b4b7a, #153a5e); border-color:#2f5e8a; }
    .btn.success { background: linear-gradient(180deg, #0e6f45, #0a5234); border-color:#15c27a; }
    .btn.ghost { background:transparent; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    /* ãã®ä»– */
    .tips { font-size:.8rem; color: var(--muted); line-height:1.5; background: #0e141b; padding: 8px; border-radius: 6px; border-left: 3px solid var(--acc); }
    .ok { color: var(--ok); }
    .err { color: var(--danger); }
    .info-box { background: rgba(74, 163, 255, 0.1); border: 1px solid rgba(74, 163, 255, 0.3); padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 0.85rem; }
    .success-box { background: rgba(21, 194, 122, 0.1); border: 1px solid rgba(21, 194, 122, 0.3); padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 0.85rem; }
    
    .exercise { border:1px dashed #2a3e53; padding:8px; border-radius:6px; margin-top:6px; }
    .set { background:#0f1821; border:1px solid #213143; padding:4px 6px; border-radius:6px; margin-bottom: 4px; }
    pre { white-space:pre-wrap; word-break:break-word; background:#0e141b; border:1px solid #1f2b36; padding:8px; border-radius:8px; font-size: 0.75rem; max-height: 300px; overflow: auto; }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center; }
    .modal.show { display:flex; }
    .modal-content { background:var(--card); border:1px solid #2a3e53; border-radius:14px; padding:24px; max-width:90%; max-height:90%; overflow:auto; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .modal-header h2 { margin:0; }
    .close-btn { background:transparent; border:none; color:var(--muted); font-size:1.5rem; cursor:pointer; padding:0; width:32px; height:32px; }
    .close-btn:hover { color:var(--ink); }
    .search-box { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #263648; background:#0e141b; color:var(--ink); margin-bottom:12px; }
    .template-table { width:100%; border-collapse:collapse; }
    .template-table th { background:#0e141b; padding:10px; text-align:left; border-bottom:2px solid #2a3e53; }
    .template-table td { padding:10px; border-bottom:1px solid #1e2a36; }
    .template-table tr:hover { background:#1a2332; }
    .copy-id-btn { background:#1b4b7a; border:1px solid #2f5e8a; padding:4px 8px; border-radius:6px; cursor:pointer; font-size:0.8rem; }
    .copy-id-btn:hover { background:#2a5a8a; }
    .favorite-star { cursor:pointer; font-size:1.2rem; }
    .favorite-star.active { color:#ffd700; }
    
    .match-suggestion { background:#1a2332; border:1px solid #2a3e53; border-radius:8px; padding:12px; margin-top:8px; }
    .match-suggestion h4 { margin:0 0 8px; font-size:0.9rem; color:#aed4ff; }
    .suggestion-list { display:flex; flex-direction:column; gap:6px; max-height:200px; overflow-y:auto; }
    .suggestion-item { background:#0f1821; border:1px solid #213143; padding:8px 12px; border-radius:6px; cursor:pointer; font-size:0.85rem; transition: all 0.2s; }
    .suggestion-item:hover { border-color:#4aa3ff; background:#1a2a3a; }
    .suggestion-item.selected { border-color:#15c27a; background:#0a2a1a; }
    .suggestion-score { color:#a9b6c6; font-size:0.75rem; margin-left:8px; }
    
    /* ğŸ’ ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å€™è£œãƒªã‚¹ãƒˆ */
    .inline-suggestions { background:#0e141b; border:1px solid #2a3e53; border-radius:6px; padding:6px; margin-top:6px; max-height:150px; overflow-y:auto; }
    .inline-suggestion-item { background:#1a2332; border:1px solid #2a3e53; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:0.8rem; transition: all 0.2s; display:flex; justify-content:space-between; align-items:center; margin-bottom:3px; }
    .inline-suggestion-item:hover { border-color:#4aa3ff; background:#1a2a3a; transform:translateX(4px); }
    .inline-suggestion-item.learned { border-color:#15c27a; background:#0a2a1a; }
    .inline-suggestion-item.learned::after { content:"ğŸ§  å­¦ç¿’æ¸ˆ"; font-size:0.75rem; color:#15c27a; margin-left:8px; }
    .learn-badge { background:rgba(21,194,122,0.2); color:#15c27a; padding:2px 8px; border-radius:4px; font-size:0.75rem; font-weight:600; }
    
    @media(max-width: 768px) {
      .step-indicator { flex-wrap: wrap; }
      .step { min-width: 100px; margin-bottom: 16px; }
      .row { flex-direction: column; }
    }
  </style>
</head>
<body>
  <h1>ğŸ‹ï¸ HEVY éå»ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆç™»éŒ²ãƒ„ãƒ¼ãƒ« <span style="font-size: 0.7em; color: var(--acc);">v6.0 ğŸ‰</span></h1>
  <div class="subtitle">ã‚¹ãƒ†ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰å¼ã§ç°¡å˜ã«ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚’ç™»éŒ²ã§ãã¾ã™</div>
  
  <!-- ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
  <div class="step-indicator">
    <div class="step active" data-step="1">
      <div class="step-circle">1</div>
      <div class="step-label">APIã‚­ãƒ¼å…¥åŠ›</div>
    </div>
    <div class="step" data-step="2">
      <div class="step-circle">2</div>
      <div class="step-label">ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</div>
    </div>
    <div class="step" data-step="3">
      <div class="step-circle">3</div>
      <div class="step-label">å†…å®¹ç¢ºèª</div>
    </div>
    <div class="step" data-step="4">
      <div class="step-circle">4</div>
      <div class="step-label">ç™»éŒ²å®Œäº†</div>
    </div>
  </div>
  
  <!-- ã‚¹ãƒ†ãƒƒãƒ—1: APIã‚­ãƒ¼å…¥åŠ› -->
  <div class="card" id="step1Card">
    <div class="card-header" onclick="toggleCard('step1Card')">
      <h2>
        <span>ğŸ”‘ ã‚¹ãƒ†ãƒƒãƒ—1: APIã‚­ãƒ¼å…¥åŠ›</span>
        <span class="status-badge active">å…¥åŠ›å¾…ã¡</span>
      </h2>
      <span class="expand-icon">â–¼</span>
    </div>
    <div class="card-content">
      <div class="info-box">
        <p style="margin: 0 0 8px; font-weight: 600;">ğŸ“ APIã‚­ãƒ¼ã®å–å¾—æ–¹æ³•ï¼š</p>
        <ol style="margin: 8px 0; padding-left: 20px;">
          <li>HEVYã‚¢ãƒ—ãƒªã¾ãŸã¯Webã‚µã‚¤ãƒˆã«ãƒ­ã‚°ã‚¤ãƒ³</li>
          <li>è¨­å®š â†’ Developer â†’ API Key ã‚’ç¢ºèª</li>
          <li>ä¸‹è¨˜ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„</li>
        </ol>
      </div>
      
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px;">
        <label style="margin-bottom: 0;">APIã‚­ãƒ¼ <span style="color: var(--danger);">*å¿…é ˆ</span></label>
        <span id="apiKeySavedIndicator" style="display: none; font-size: 0.75rem; color: var(--ok);">ğŸ”’ ä¿å­˜æ¸ˆã¿</span>
      </div>
      <input id="apiKey" type="text" placeholder="ä¾‹: 03a6960b-1234-5678-90ab-cdef12345678" autocomplete="off" />
      
      <div style="margin-top: 16px; display: flex; gap: 8px; justify-content: space-between; flex-wrap: wrap;">
        <button class="btn ghost" onclick="clearApiKey()" style="background: var(--danger); border-color: var(--danger);">ğŸ—‘ APIã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢</button>
        <div style="display: flex; gap: 8px;">
          <button class="btn ghost" onclick="refetchTemplates()" style="font-size: 0.75rem;">ğŸ”„ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å†å–å¾—</button>
          <button class="btn ghost" onclick="testApiKey()">ğŸ” æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
          <button class="btn primary" onclick="completeStep1()" id="step1NextBtn" disabled>æ¬¡ã¸ â†’</button>
        </div>
      </div>
      
      <div id="apiTestResult" style="margin-top: 12px; display: none;"></div>
    </div>
  </div>
  
  <!-- ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ‡ãƒ¼ã‚¿å…¥åŠ› -->
  <div class="card collapsed" id="step2Card">
    <div class="card-header" onclick="toggleCard('step2Card')">
      <h2>
        <span>ğŸ“ ã‚¹ãƒ†ãƒƒãƒ—2: ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</span>
        <span class="status-badge pending">æœªå…¥åŠ›</span>
      </h2>
      <span class="expand-icon">â–¼</span>
    </div>
    <div class="card-content">
      <div style="display: flex; gap: 12px; margin-bottom: 16px;">
        <button class="btn" onclick="showTemplatesModal()">ğŸ“‹ ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºä¸€è¦§</button>
        <button class="btn" onclick="showFavoritesModal()">â­ ãŠæ°—ã«å…¥ã‚Š</button>
        <button class="btn" onclick="showLearningModal()">ğŸ§  å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ç®¡ç†</button>
      </div>
      
      <div class="info-box">
        <p style="margin: 0 0 8px; font-weight: 600;">ğŸ’¡ 2ã¤ã®å…¥åŠ›æ–¹æ³•ãŒã‚ã‚Šã¾ã™ï¼š</p>
        <p style="margin: 0;"><strong>æ–¹æ³•1ï¼ˆæ¨å¥¨ï¼‰:</strong> ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒãƒ¼ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦è‡ªå‹•è§£æ</p>
        <p style="margin: 4px 0 0; font-size: 0.85rem; color: var(--muted);">
          å¿…é ˆï¼šã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºåã¨é‡é‡ãƒ»å›æ•°ãƒ»ã‚»ãƒƒãƒˆæ•°<br>
          ä¾‹ï¼šã€Œã‚¹ãƒŸã‚¹ãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ 97.5kgÃ—6Ã—3ã€
        </p>
        <p style="margin: 12px 0 0;"><strong>æ–¹æ³•2:</strong> æ‰‹å‹•ã§ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›</p>
        <p style="margin: 4px 0 0; font-size: 0.85rem; color: var(--muted);">
          ã€Œâ• ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã§ç¨®ç›®ã‚’è¿½åŠ 
        </p>
      </div>
      
      <label>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ï¼ˆè‡ªå‹•è§£æï¼‰</label>
      <textarea id="rawData" placeholder="ä¾‹ï¼š&#10;10/14&#10;æ™‚é–“/ç¨®ç›®/åˆè¨ˆï¼š120åˆ†ï¼11ç¨®ç›®ï¼9,801kg&#10;ãƒ¡ã‚¤ãƒ³ï¼š&#10;ã‚¹ãƒŸã‚¹ãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ 97.5kgÃ—6Ã—3&#10;ãƒ’ãƒƒãƒ—ã‚¹ãƒ©ã‚¹ãƒˆ 130kgÃ—10Ã—3&#10;ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒ»ãƒãƒ  è‡ªé‡Ã—15Ã—2"></textarea>
      
      <div style="margin-top: 12px; display: flex; gap: 12px; justify-content: flex-end;">
        <button class="btn ghost" onclick="clearData()">ğŸ—‘ ã‚¯ãƒªã‚¢</button>
        <button class="btn primary" onclick="parseAndFill()">ğŸ“¥ è‡ªå‹•å…¥åŠ›</button>
      </div>
      
      <div id="parseInfo" style="margin-top: 12px; display: none;"></div>
      
      <hr style="border: none; border-top: 1px solid #1e2a36; margin: 24px 0;" />
      
      <h3 style="font-size: 1rem; margin-bottom: 16px;">ã¾ãŸã¯ã€æ‰‹å‹•ã§å…¥åŠ›ï¼š</h3>
      
      <div id="manualForm">
        <div class="row">
          <div>
            <label>ã‚¿ã‚¤ãƒˆãƒ« <span style="color: var(--danger);">*</span></label>
            <input id="title" type="text" placeholder="ä¾‹: ãƒ¬ãƒƒã‚°ãƒ‡ã‚¤" />
          </div>
        </div>
        
        <div class="info-box" style="margin-bottom: 12px;">
          <p style="margin: 0 0 8px; font-weight: 600;">â° ã‚¯ã‚¤ãƒƒã‚¯æ—¥æ™‚è¨­å®šï¼š</p>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn ghost" style="font-size: 0.75rem; padding: 4px 10px;" onclick="setQuickDateTime('past-today')">ğŸ“… ä»Šæ—¥ï¼ˆéå»ï¼‰</button>
            <button class="btn ghost" style="font-size: 0.75rem; padding: 4px 10px;" onclick="setQuickDateTime('tomorrow')">ğŸ“… æ˜æ—¥</button>
            <button class="btn ghost" style="font-size: 0.75rem; padding: 4px 10px;" onclick="setQuickDateTime('day-after')">ğŸ“… æ˜å¾Œæ—¥</button>
            <button class="btn ghost" style="font-size: 0.75rem; padding: 4px 10px;" onclick="setQuickDateTime('next-week')">ğŸ“… æ¥é€±</button>
            <button class="btn ghost" style="font-size: 0.75rem; padding: 4px 10px;" onclick="setQuickDateTime('custom-future')">ğŸ”§ ã‚«ã‚¹ã‚¿ãƒ ï¼ˆæœªæ¥ï¼‰</button>
          </div>
        </div>
        
        <div class="row">
          <div>
            <label>é–‹å§‹æ—¥æ™‚ï¼ˆJSTï¼‰<span style="color: var(--danger);">*</span></label>
            <input id="startTime" type="datetime-local" />
          </div>
          <div>
            <label>çµ‚äº†æ—¥æ™‚ï¼ˆJSTï¼‰<span style="color: var(--danger);">*</span></label>
            <input id="endTime" type="datetime-local" />
          </div>
        </div>
        
        <div class="row">
          <div>
            <label>èª¬æ˜ï¼ˆä»»æ„ï¼‰</label>
            <input id="description" type="text" placeholder="ãƒ¡ãƒ¢ç­‰" />
          </div>
          <div style="display: flex; align-items: flex-end;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input id="isPrivate" type="checkbox" style="width: auto; margin-right: 8px;" />
              <span>éå…¬é–‹ã«ã™ã‚‹</span>
            </label>
          </div>
        </div>
        
        <div id="exList"></div>
        
        <button class="btn" onclick="addExercise()">â• ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºã‚’è¿½åŠ </button>
      </div>
      
      <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
        <button class="btn ghost" onclick="goToStep(1)">â† æˆ»ã‚‹</button>
        <button class="btn primary" onclick="completeStep2()" id="step2NextBtn">æ¬¡ã¸ â†’</button>
      </div>
    </div>
  </div>
  
  <!-- ã‚¹ãƒ†ãƒƒãƒ—3: å†…å®¹ç¢ºèª -->
  <div class="card collapsed" id="step3Card">
    <div class="card-header" onclick="toggleCard('step3Card')">
      <h2>
        <span>âœ… ã‚¹ãƒ†ãƒƒãƒ—3: å†…å®¹ç¢ºèª</span>
        <span class="status-badge pending">æœªç¢ºèª</span>
      </h2>
      <span class="expand-icon">â–¼</span>
    </div>
    <div class="card-content">
      <div class="tips">
        <p style="margin: 0;"><strong>âš ï¸ é€ä¿¡å‰ã«ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š</strong></p>
        <ul style="margin: 8px 0 0; padding-left: 20px;">
          <li>ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹</li>
          <li>é–‹å§‹æ—¥æ™‚ãŒçµ‚äº†æ—¥æ™‚ã‚ˆã‚Šå‰ã«ãªã£ã¦ã„ã‚‹ã‹</li>
          <li>ã‚»ãƒƒãƒˆã®å†…å®¹ï¼ˆé‡é‡ãƒ»å›æ•°ï¼‰ãŒæ­£ã—ã„ã‹</li>
        </ul>
      </div>
      
      <h3 style="font-size: 1rem; margin: 16px 0 8px;">é€ä¿¡ã™ã‚‹JSONãƒ‡ãƒ¼ã‚¿ï¼š</h3>
      <pre id="preview">{ }</pre>
      
      <div id="validationResult" style="margin-top: 12px;"></div>
      
      <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
        <button class="btn ghost" onclick="goToStep(2)">â† æˆ»ã‚‹</button>
        <button class="btn ghost" onclick="refreshPreview()">ğŸ”„ æ›´æ–°</button>
        <button class="btn success" onclick="submitWorkout()" id="submitBtn" disabled>ğŸ“¤ ç™»éŒ²ã™ã‚‹</button>
      </div>
    </div>
  </div>
  
  <!-- ã‚¹ãƒ†ãƒƒãƒ—4: ç™»éŒ²å®Œäº† -->
  <div class="card collapsed" id="step4Card">
    <div class="card-header" onclick="toggleCard('step4Card')">
      <h2>
        <span>ğŸ‰ ã‚¹ãƒ†ãƒƒãƒ—4: ç™»éŒ²çµæœ</span>
        <span class="status-badge pending">æœªé€ä¿¡</span>
      </h2>
      <span class="expand-icon">â–¼</span>
    </div>
    <div class="card-content">
      <div id="responseArea">
        <p style="color: var(--muted); text-align: center; padding: 40px 0;">é€ä¿¡å¾Œã«ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
      </div>
      
      <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: center;">
        <button class="btn primary" onclick="resetAll()" style="display: none;" id="resetBtn">ğŸ”„ æœ€åˆã‹ã‚‰ç™»éŒ²ã™ã‚‹</button>
      </div>
    </div>
  </div>
  
  <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="templatesModal" class="modal">
    <div class="modal-content" style="width:1000px;">
      <div class="modal-header">
        <h2>ğŸ“‹ ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§</h2>
        <button class="close-btn" onclick="closeModal('templatesModal')">Ã—</button>
      </div>
      <input type="text" id="templateSearch" class="search-box" placeholder="ğŸ” ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºåã§æ¤œç´¢..." oninput="filterTemplates()">
      <div style="max-height:600px; overflow-y:auto;">
        <table class="template-table">
          <thead>
            <tr>
              <th style="width:40px;">â­</th>
              <th>ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºå</th>
              <th style="width:120px;">ID</th>
              <th style="width:100px;">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
            </tr>
          </thead>
          <tbody id="templateTableBody">
            <tr><td colspan="4" style="text-align:center; padding:20px;">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- ãŠæ°—ã«å…¥ã‚Šç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="favoritesModal" class="modal">
    <div class="modal-content" style="width:800px;">
      <div class="modal-header">
        <h2>â­ ãŠæ°—ã«å…¥ã‚Šã‚¨ã‚¯ã‚µã‚µã‚¤ã‚º</h2>
        <button class="close-btn" onclick="closeModal('favoritesModal')">Ã—</button>
      </div>
      <div id="favoritesList"></div>
    </div>
  </div>
  
  <!-- ğŸ§  å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="learningModal" class="modal">
    <div class="modal-content" style="width:900px;">
      <div class="modal-header">
        <h2>ğŸ§  AIå­¦ç¿’ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
        <button class="close-btn" onclick="closeModal('learningModal')">Ã—</button>
      </div>
      <div class="info-box" style="margin-bottom: 16px;">
        <p style="margin: 0;"><strong>ğŸ’¡ å­¦ç¿’æ©Ÿèƒ½ã«ã¤ã„ã¦ï¼š</strong></p>
        <p style="margin: 8px 0 0;">æ‰‹å‹•ã§é¸æŠã—ãŸã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è¨˜æ†¶ã—ã€æ¬¡å›ã‹ã‚‰è‡ªå‹•çš„ã«é©ç”¨ã—ã¾ã™ã€‚ä¸è¦ãªãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã§ãã¾ã™ã€‚</p>
      </div>
      <div id="learningDataList"></div>
      <div style="margin-top: 16px; text-align: center;">
        <button class="btn" style="background: var(--danger); border-color: var(--danger);" onclick="clearAllLearningData()">ğŸ—‘ ã™ã¹ã¦ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>
      </div>
    </div>
  </div>
  
  <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ -->
  <template id="exerciseTpl">
    <div class="exercise">
      <div class="row" style="align-items:flex-end;">
        <div style="flex: 2;">
          <label>ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆID <span style="color: var(--danger);">*</span></label>
          <div style="display:flex; gap:8px; align-items:center;">
            <input class="tplId" type="text" placeholder="ä¾‹: D0A4C939" style="flex:1;" />
            <button type="button" class="btn ghost" onclick="searchInline(this)" style="padding:10px 14px; flex-shrink:0;">ğŸ”</button>
          </div>
        </div>
        <div style="flex: 1;">
          <label>ãƒãƒ¼ãƒˆ</label>
          <input class="exNote" type="text" placeholder="ãƒ•ã‚©ãƒ¼ãƒ ç­‰" />
        </div>
        <div style="flex: 0 0 auto;">
          <button type="button" class="btn" style="background: var(--danger); border-color: var(--danger);" onclick="this.closest('.exercise').remove()">ğŸ—‘</button>
        </div>
      </div>
      <div class="inline-suggestions-container"></div>
      <div class="sets"></div>
      <button type="button" class="btn ghost" onclick="addSetToExercise(this)">â• ã‚»ãƒƒãƒˆè¿½åŠ </button>
    </div>
  </template>
  
  <template id="setTpl">
    <div class="set row">
      <div style="flex: 0 0 80px;">
        <label>ç¨®é¡</label>
        <input class="type" type="text" value="normal" />
      </div>
      <div>
        <label>é‡é‡(kg)</label>
        <input class="w" type="number" step="0.1" />
      </div>
      <div>
        <label>åå¾©æ•°</label>
        <input class="r" type="number" />
      </div>
      <div>
        <label>æ™‚é–“(ç§’)</label>
        <input class="dur" type="number" />
      </div>
      <div>
        <label>è·é›¢(m)</label>
        <input class="dist" type="number" />
      </div>
      <div>
        <label>RPE</label>
        <input class="rpe" type="number" step="0.5" />
      </div>
      <div style="flex: 0 0 auto; align-self: flex-end;">
        <button type="button" class="btn" style="background: var(--danger); border-color: var(--danger); padding: 10px;" onclick="this.closest('.set').remove()">Ã—</button>
      </div>
    </div>
  </template>
  
  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentStep = 1;
    let allTemplates = [];
    
    // ğŸ”’ APIã‚­ãƒ¼æ°¸ç¶šä¿å­˜
    const API_KEY_STORAGE_KEY = 'hevy_api_key_v1';
    
    // ğŸ“¦ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿æ°¸ç¶šä¿å­˜
    const TEMPLATES_STORAGE_KEY = 'hevy_templates_v1';
    const TEMPLATES_TIMESTAMP_KEY = 'hevy_templates_timestamp_v1';
    
    // ğŸ§  æ©Ÿæ¢°å­¦ç¿’ï¼šLocalStorageã‚’ä½¿ã£ãŸå­¦ç¿’ãƒ‡ãƒ¼ã‚¿
    const LEARNING_STORAGE_KEY = 'hevy_exercise_learning_v1';
    
    function getLearnedMappings() {
      try {
        const data = localStorage.getItem(LEARNING_STORAGE_KEY);
        return data ? JSON.parse(data) : {};
      } catch (e) {
        console.error('å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        return {};
      }
    }
    
    function saveLearnedMapping(japaneseName, templateId, templateTitle) {
      try {
        const mappings = getLearnedMappings();
        const normalized = japaneseName.toLowerCase().trim();
        mappings[normalized] = { id: templateId, title: templateTitle, count: (mappings[normalized]?.count || 0) + 1, lastUsed: Date.now() };
        localStorage.setItem(LEARNING_STORAGE_KEY, JSON.stringify(mappings));
        console.log(`ğŸ§  å­¦ç¿’: "${japaneseName}" â†’ "${templateTitle}" (ID: ${templateId})`);
      } catch (e) {
        console.error('å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
      }
    }
    
    function getLearnedTemplate(japaneseName) {
      const mappings = getLearnedMappings();
      const normalized = japaneseName.toLowerCase().trim();
      return mappings[normalized] || null;
    }
    
    // ğŸ”’ APIã‚­ãƒ¼ç®¡ç†é–¢æ•°
    function loadApiKey() {
      try {
        const savedKey = localStorage.getItem(API_KEY_STORAGE_KEY);
        if (savedKey) {
          document.getElementById('apiKey').value = savedKey;
          document.getElementById('apiKey').classList.add('valid');
          document.getElementById('apiKeySavedIndicator').style.display = 'inline';
          document.getElementById('step1NextBtn').disabled = false;
          console.log('ğŸ”’ ä¿å­˜æ¸ˆã¿APIã‚­ãƒ¼ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
          return true;
        }
      } catch (e) {
        console.error('APIã‚­ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
      }
      return false;
    }
    
    function saveApiKey(apiKey) {
      try {
        localStorage.setItem(API_KEY_STORAGE_KEY, apiKey);
        document.getElementById('apiKeySavedIndicator').style.display = 'inline';
        console.log('ğŸ”’ APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      } catch (e) {
        console.error('APIã‚­ãƒ¼ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
      }
    }
    
    function clearApiKey() {
      if (confirm('ä¿å­˜ã•ã‚Œã¦ã„ã‚‹APIã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\n\næ¬¡å›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«å†å…¥åŠ›ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚')) {
        try {
          localStorage.removeItem(API_KEY_STORAGE_KEY);
          document.getElementById('apiKey').value = '';
          document.getElementById('apiKey').classList.remove('valid');
          document.getElementById('apiKeySavedIndicator').style.display = 'none';
          document.getElementById('step1NextBtn').disabled = true;
          document.getElementById('apiTestResult').style.display = 'none';
          allTemplates = [];
          alert('âœ… APIã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
          console.log('ğŸ—‘ APIã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        } catch (e) {
          console.error('APIã‚­ãƒ¼ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', e);
        }
      }
    }
    
    // ğŸ“¦ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ç®¡ç†é–¢æ•°
    function saveTemplates(templates) {
      try {
        localStorage.setItem(TEMPLATES_STORAGE_KEY, JSON.stringify(templates));
        localStorage.setItem(TEMPLATES_TIMESTAMP_KEY, Date.now().toString());
        console.log(`ğŸ“¦ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ ${templates.length}ä»¶ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
      } catch (e) {
        console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
        // LocalStorageã®å®¹é‡è¶…éã®å¯èƒ½æ€§
        if (e.name === 'QuotaExceededError') {
          console.warn('âš ï¸ LocalStorageå®¹é‡ä¸è¶³ã€‚å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚');
          // å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ä»¥å¤–ã‚’ã‚¯ãƒªã‚¢
          localStorage.removeItem(TEMPLATES_STORAGE_KEY);
          localStorage.removeItem(TEMPLATES_TIMESTAMP_KEY);
          // å†è©¦è¡Œ
          try {
            localStorage.setItem(TEMPLATES_STORAGE_KEY, JSON.stringify(templates));
            localStorage.setItem(TEMPLATES_TIMESTAMP_KEY, Date.now().toString());
            console.log('âœ… å†ä¿å­˜æˆåŠŸ');
          } catch (e2) {
            console.error('âŒ å†ä¿å­˜ã‚‚å¤±æ•—:', e2);
          }
        }
      }
    }
    
    function loadTemplates() {
      try {
        const data = localStorage.getItem(TEMPLATES_STORAGE_KEY);
        const timestamp = localStorage.getItem(TEMPLATES_TIMESTAMP_KEY);
        
        if (data && timestamp) {
          const templates = JSON.parse(data);
          const savedDate = new Date(parseInt(timestamp));
          console.log(`ğŸ“¦ ä¿å­˜æ¸ˆã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ ${templates.length}ä»¶ã‚’å¾©å…ƒã—ã¾ã—ãŸ`);
          console.log(`   å–å¾—æ—¥æ™‚: ${savedDate.toLocaleString('ja-JP')}`);
          
          // 30æ—¥ä»¥ä¸Šå¤ã„å ´åˆã¯è­¦å‘Š
          const daysPassed = (Date.now() - parseInt(timestamp)) / (1000 * 60 * 60 * 24);
          if (daysPassed > 30) {
            console.warn(`âš ï¸ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãŒ${Math.floor(daysPassed)}æ—¥å‰ã®ã‚‚ã®ã§ã™ã€‚å†å–å¾—ã‚’æ¨å¥¨ã—ã¾ã™ã€‚`);
          }
          
          return { templates, timestamp: parseInt(timestamp) };
        }
      } catch (e) {
        console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
      }
      return null;
    }
    
    function clearTemplates() {
      try {
        localStorage.removeItem(TEMPLATES_STORAGE_KEY);
        localStorage.removeItem(TEMPLATES_TIMESTAMP_KEY);
        console.log('ğŸ“¦ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
      } catch (e) {
        console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', e);
      }
    }
    
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    function updateStepIndicator(step) {
      document.querySelectorAll('.step').forEach(el => {
        const stepNum = parseInt(el.dataset.step);
        el.classList.remove('active', 'complete');
        if (stepNum < step) el.classList.add('complete');
        if (stepNum === step) el.classList.add('active');
      });
    }
    
    function updateStepStatus(cardId, status) {
      const card = document.getElementById(cardId);
      const badge = card.querySelector('.status-badge');
      badge.className = 'status-badge ' + status;
      badge.textContent = status === 'complete' ? 'å®Œäº†' : status === 'active' ? 'å…¥åŠ›ä¸­' : 'æœªå…¥åŠ›';
    }
    
    function goToStep(step) {
      currentStep = step;
      updateStepIndicator(step);
      
      // ã™ã¹ã¦ã®ã‚«ãƒ¼ãƒ‰ã‚’æŠ˜ã‚ŠãŸãŸã‚€
      document.querySelectorAll('.card').forEach(c => c.classList.add('collapsed'));
      
      // å¯¾è±¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’é–‹ã
      const targetCard = document.getElementById(`step${step}Card`);
      if (targetCard) {
        targetCard.classList.remove('collapsed');
        targetCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
      
      // ã‚¹ãƒ†ãƒƒãƒ—2ã‚’é–‹ã„ãŸæ™‚ã€ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºãŒ0ãªã‚‰1ã¤è¿½åŠ 
      if (step === 2 && exList.querySelectorAll('.exercise').length === 0) {
        addExercise();
      }
    }
    
    function toggleCard(cardId) {
      document.getElementById(cardId).classList.toggle('collapsed');
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }
    
    // ã‚¹ãƒ†ãƒƒãƒ—1: APIã‚­ãƒ¼
    document.getElementById('apiKey').addEventListener('input', (e) => {
      const btn = document.getElementById('step1NextBtn');
      btn.disabled = !e.target.value.trim();
      if (e.target.value.trim()) {
        e.target.classList.add('valid');
      } else {
        e.target.classList.remove('valid');
      }
    });
    
    async function refetchTemplates() {
      if (!confirm('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ã—ã¾ã™ã‹ï¼Ÿ\n\nä¿å­˜æ¸ˆã¿ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãŒæœ€æ–°ã®ã‚‚ã®ã«æ›´æ–°ã•ã‚Œã¾ã™ã€‚')) {
        return;
      }
      
      // æ—¢å­˜ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
      clearTemplates();
      allTemplates = [];
      
      // æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆè‡ªå‹•çš„ã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å†å–å¾—ãƒ»ä¿å­˜ï¼‰
      await testApiKey();
    }
    
    async function testApiKey() {
      const apiKey = document.getElementById('apiKey').value.trim();
      const resultDiv = document.getElementById('apiTestResult');
      
      if (!apiKey) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<p class="err">âš ï¸ APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>';
        return;
      }
      
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<p style="color: var(--muted);">ğŸ”„ å…¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—ä¸­...</p>';
      
      try {
        // ğŸš€ ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼šå…¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—
        allTemplates = [];
        let page = 0;
        let hasMore = true;
        
        while (hasMore) {
          const response = await fetch(`https://api.hevyapp.com/v1/exercise_templates?page=${page}&pageSize=100`, {
            headers: { 'api-key': apiKey }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const data = await response.json();
          const templates = data.exercise_templates || data.data || data;
          
          if (Array.isArray(templates) && templates.length > 0) {
            allTemplates = allTemplates.concat(templates);
            console.log(`ãƒšãƒ¼ã‚¸ ${page}: ${templates.length}ä»¶å–å¾— (ç´¯è¨ˆ: ${allTemplates.length}ä»¶)`);
            page++;
            
            // 100ä»¶æœªæº€ãªã‚‰æœ€çµ‚ãƒšãƒ¼ã‚¸
            if (templates.length < 100) {
              hasMore = false;
            }
          } else {
            hasMore = false;
          }
          
          // å®‰å…¨è£…ç½®ï¼š10ãƒšãƒ¼ã‚¸ä»¥ä¸Šã¯å–å¾—ã—ãªã„
          if (page >= 10) {
            console.warn('âš ï¸ 10ãƒšãƒ¼ã‚¸ã«é”ã—ãŸãŸã‚ã€å–å¾—ã‚’ä¸­æ–­ã—ã¾ã—ãŸ');
            hasMore = false;
          }
        }
        
        if (allTemplates.length > 0) {
          // ğŸ”’ APIã‚­ãƒ¼ã‚’ä¿å­˜
          saveApiKey(apiKey);
          
          // ğŸ“¦ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜
          saveTemplates(allTemplates);
          
          // ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¿½åŠ 
          console.log('=== API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ ãƒ‡ãƒãƒƒã‚° ===');
          console.log('allTemplates.length:', allTemplates.length);
          console.log('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ§‹é€ ï¼ˆ1ä»¶ç›®ï¼‰:', allTemplates[0]);
          
          // Hip, Nordic, Plank, Calf ã‚’å«ã‚€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ¤œç´¢
          const hipTemplates = allTemplates.filter(t => t.title.toLowerCase().includes('hip'));
          const nordicTemplates = allTemplates.filter(t => t.title.toLowerCase().includes('nordic'));
          const plankTemplates = allTemplates.filter(t => t.title.toLowerCase().includes('plank'));
          const calfTemplates = allTemplates.filter(t => t.title.toLowerCase().includes('calf'));
          
          console.log('"Hip" ã‚’å«ã‚€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ:', hipTemplates.map(t => t.title));
          console.log('"Nordic" ã‚’å«ã‚€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ:', nordicTemplates.map(t => t.title));
          console.log('"Plank" ã‚’å«ã‚€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ:', plankTemplates.map(t => t.title));
          console.log('"Calf" ã‚’å«ã‚€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ:', calfTemplates.map(t => t.title));
          console.log('================================');
          
          resultDiv.innerHTML = `<div class="success-box">
            <p class="ok" style="margin: 0 0 8px;">âœ… æ¥ç¶šæˆåŠŸï¼ ${allTemplates.length}ä»¶ã®ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—ã—ã¾ã—ãŸ</p>
            <p style="font-size: 0.85rem; color: var(--muted); margin: 4px 0 0;">ğŸš€ ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œæ¸ˆã¿ - å…¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—æ¸ˆã¿</p>
            <details style="font-size: 0.85rem; color: var(--muted); margin-top: 8px;">
              <summary style="cursor: pointer; user-select: none;">ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º</summary>
              <pre style="margin-top: 8px; max-height: 300px; overflow: auto;">${JSON.stringify(allTemplates.slice(0, 5), null, 2)}</pre>
            </details>
          </div>`;
          document.getElementById('step1NextBtn').disabled = false;
        } else {
          resultDiv.innerHTML = `<p class="err">âŒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</p>`;
        }
      } catch (e) {
        resultDiv.innerHTML = `<p class="err">âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}</p>`;
      }
    }
    
    function completeStep1() {
      if (allTemplates.length === 0) {
        alert('å…ˆã«ã€Œæ¥ç¶šãƒ†ã‚¹ãƒˆã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
        return;
      }
      updateStepStatus('step1Card', 'complete');
      updateStepStatus('step2Card', 'active');
      goToStep(2);
    }
    
    // ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ‡ãƒ¼ã‚¿å…¥åŠ›
    const exList = document.getElementById('exList');
    const exTpl = document.getElementById('exerciseTpl');
    const setTpl = document.getElementById('setTpl');
    
    function toISO(dtLocal) {
      if (!dtLocal) return null;
      const d = new Date(dtLocal);
      if (isNaN(d.getTime())) return null;
      const iso = d.toISOString();
      console.log(`ğŸ• æ™‚åˆ»å¤‰æ›: ${dtLocal} â†’ ${iso}`);
      return iso;
    }
    
    // â° ã‚¯ã‚¤ãƒƒã‚¯æ—¥æ™‚è¨­å®šæ©Ÿèƒ½
    function setQuickDateTime(type) {
      const now = new Date();
      let startDate, endDate;
      
      switch(type) {
        case 'past-today':
          // ä»Šæ—¥ã®9:00-10:30ï¼ˆéå»ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ï¼‰
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 9, 0);
          endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 10, 30);
          break;
          
        case 'tomorrow':
          // æ˜æ—¥ã®9:00-10:30
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 9, 0);
          endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 10, 30);
          break;
          
        case 'day-after':
          // æ˜å¾Œæ—¥ã®9:00-10:30
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 2, 9, 0);
          endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 2, 10, 30);
          break;
          
        case 'next-week':
          // æ¥é€±ã®ä»Šæ—¥ã®9:00-10:30
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 7, 9, 0);
          endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 7, 10, 30);
          break;
          
        case 'custom-future':
          // ã‚«ã‚¹ã‚¿ãƒ ï¼ˆ3æ—¥å¾Œã®9:00-10:30ï¼‰
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 3, 9, 0);
          endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 3, 10, 30);
          break;
          
        default:
          return;
      }
      
      // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: YYYY-MM-DDTHH:MM
      const formatDateTime = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hour = String(date.getHours()).padStart(2, '0');
        const minute = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hour}:${minute}`;
      };
      
      document.getElementById('startTime').value = formatDateTime(startDate);
      document.getElementById('endTime').value = formatDateTime(endDate);
      
      console.log(`â° ã‚¯ã‚¤ãƒƒã‚¯æ—¥æ™‚è¨­å®š: ${type}`);
      console.log(`   é–‹å§‹: ${formatDateTime(startDate)}`);
      console.log(`   çµ‚äº†: ${formatDateTime(endDate)}`);
    }
    
    function addExercise() {
      const node = exTpl.content.firstElementChild.cloneNode(true);
      const setsWrap = node.querySelector('.sets');
      
      // æ—¢å®šã§1ã‚»ãƒƒãƒˆè¿½åŠ 
      const s = setTpl.content.firstElementChild.cloneNode(true);
      setsWrap.appendChild(s);
      
      exList.appendChild(node);
    }
    
    function addSetToExercise(button) {
      const exercise = button.closest('.exercise');
      const setsWrap = exercise.querySelector('.sets');
      const s = setTpl.content.firstElementChild.cloneNode(true);
      setsWrap.appendChild(s);
    }
    
    function clearData() {
      document.getElementById('rawData').value = '';
      document.getElementById('parseInfo').style.display = 'none';
      exList.innerHTML = '';
      document.getElementById('title').value = '';
      document.getElementById('description').value = '';
      document.getElementById('startTime').value = '';
      document.getElementById('endTime').value = '';
    }
    
    // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿è§£ææ©Ÿèƒ½
    function parseWorkoutData(text) {
      const lines = text.split('\n').map(l => l.trim()).filter(l => l);
      const exercises = [];
      let currentDate = '';
      let totalTime = 0;
      let currentExercise = null;
      let inSetDetails = false;
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        // ğŸ“… æ—¥ä»˜ã‚’æ¤œå‡º (ä¾‹: 10/14 ã¾ãŸã¯ 8æœˆ29æ—¥)
        if (/^\d{1,2}\/\d{1,2}/.test(line)) {
          currentDate = line;
          continue;
        }
        
        // ğŸ“… æ—¥æœ¬èªå½¢å¼ã®æ—¥ä»˜ (ä¾‹: 8æœˆ29æ—¥)
        const jpDateMatch = line.match(/(\d{1,2})æœˆ(\d{1,2})æ—¥/);
        if (jpDateMatch) {
          currentDate = `${jpDateMatch[1]}/${jpDateMatch[2]}`;
          continue;
        }
        
        // ğŸš« ã‚¹ã‚­ãƒƒãƒ—ã™ã¹ãè¡Œï¼ˆå…ˆã«åˆ¤å®šï¼‰
        if (/^(ãƒ¡ã‚¤ãƒ³|è£œåŠ©|ã‚µãƒ–)[ï¼š:]?\s*$/.test(line)) {
          continue;
        }
        if (/^(ãƒ¬ãƒ™ãƒ«|åˆè¨ˆé‡é‡|æ¶ˆè²»ã‚«ãƒ­ãƒª|æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼|è¨˜éŒ²)[ï¼š:]/.test(line)) {
          continue;
        }
        // è¨˜éŒ²ã®è©³ç´°è¡Œï¼ˆç‹å† ãƒãƒ¼ã‚¯ãªã©ï¼‰ã‚’ã‚¹ã‚­ãƒƒãƒ—
        if (line.startsWith('â€¢') && /^â€¢\s*ğŸ‘‘/.test(line)) {
          continue;
        }
        if (line === 'ã‚»ãƒƒãƒˆè©³ç´°:' || line === 'ã‚»ãƒƒãƒˆè©³ç´°ï¼š') {
          inSetDetails = true;
          continue;
        }
        if (line === 'ã‚µãƒãƒªãƒ¼' || line === 'Exercise Details' || line.startsWith('ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²')) {
          continue;
        }
        // å˜ç‹¬ã® bullet point ã®ã¿ã®è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
        if (line === 'â€¢' || line === 'ãƒ»') {
          continue;
        }
        
        // ğŸ• æ™‚é–“æƒ…å ±ã‚’æ¤œå‡ºï¼ˆbullet pointä»˜ãã‚‚å¯¾å¿œï¼‰
        const timeMatch = line.match(/(\d+)åˆ†/);
        if (timeMatch && /ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ™‚é–“|æ‰€è¦æ™‚é–“/.test(line)) {
          totalTime = parseInt(timeMatch[1]);
          console.log(`â±ï¸ ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ™‚é–“ã‚’æ¤œå‡º: ${totalTime}åˆ†`);
          continue;
        }
        
        // ã‚µãƒãƒªãƒ¼è¡Œã®ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ•°ã€æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼ãªã©ï¼‰
        if (line.startsWith('â€¢') && /^â€¢\s*(ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ•°|æ¶ˆè²»ã‚«ãƒ­ãƒª|æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼|åˆè¨ˆé‡é‡)/.test(line)) {
          continue;
        }
        
        // ğŸ‹ï¸ ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºåã‚’æ¤œå‡ºï¼ˆç•ªå·ä»˜ãå½¢å¼: "1. ãƒãƒ¼ãƒ™ãƒ«ãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ"ï¼‰
        const numberedExMatch = line.match(/^\d+\.\s*(.+)$/);
        if (numberedExMatch) {
          if (currentExercise && currentExercise.sets.length > 0) {
            exercises.push(currentExercise);
          }
          currentExercise = {
            name: numberedExMatch[1].trim(),
            sets: []
          };
          inSetDetails = false;
          continue;
        }
        
        // ğŸ“ ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºåã‚’æŠ½å‡ºï¼ˆå¾“æ¥å½¢å¼ï¼šã‚³ãƒ­ãƒ³åŒºåˆ‡ã‚Šãªã©ï¼‰
        let exerciseName = '';
        let dataStr = line;
        
        // ğŸ¯ ã‚»ãƒƒãƒˆè©³ç´°ãƒ¢ãƒ¼ãƒ‰ä¸­ã®ãƒ‡ãƒ¼ã‚¿è¡Œï¼ˆbullet pointä»˜ãï¼‰
        if (currentExercise && (inSetDetails || line.startsWith('â€¢') || line.startsWith('ãƒ»'))) {
          // Bullet pointã‚’å‰Šé™¤
          let cleanLine = line.replace(/^[â€¢ãƒ»]\s*/, '');
          
          // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
          if (/^(ãƒ¬ãƒ™ãƒ«|åˆè¨ˆé‡é‡|æ¶ˆè²»ã‚«ãƒ­ãƒª|æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼|ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°|æ‰€è¦æ™‚é–“|ğŸ‘‘)[ï¼š:]/.test(cleanLine)) {
            continue;
          }
          // ç‹å† ãƒãƒ¼ã‚¯ä»˜ãè¨˜éŒ²è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
          if (cleanLine.startsWith('ğŸ‘‘')) {
            continue;
          }
          
          // è‡ªé‡å½¢å¼: "10å›" ã ã‘ï¼ˆkgãªã—ï¼‰
          const bwOnlyMatch = cleanLine.match(/^(\d+)\s*(?:å›|rep)$/i);
          if (bwOnlyMatch) {
            currentExercise.sets.push({ reps: parseInt(bwOnlyMatch[1]) });
            continue;
          }
          
          // kgä»˜ãå½¢å¼: "80kg Ã— 5å›"
          const kgMatch = cleanLine.match(/([0-9.]+)\s*kg\s*[Ã—xX]\s*(\d+)\s*(?:å›|rep)?/i);
          if (kgMatch) {
            currentExercise.sets.push({
              weight: parseFloat(kgMatch[1]),
              reps: parseInt(kgMatch[2])
            });
            continue;
          }
          
          // è‡ªé‡ Ã— å›æ•° å½¢å¼
          const bwMatch = cleanLine.match(/è‡ªé‡\s*[Ã—xX]\s*(\d+)\s*(?:å›|rep)?/i);
          if (bwMatch) {
            currentExercise.sets.push({ reps: parseInt(bwMatch[1]) });
            continue;
          }
          
          // æ™‚é–“å½¢å¼: "30ç§’"
          const durMatch = cleanLine.match(/(\d+)\s*ç§’/i);
          if (durMatch) {
            currentExercise.sets.push({ duration: parseInt(durMatch[1]) });
            continue;
          }
          
          // ç©ºè¡Œã‚„ãã®ä»–ã¯ã‚¹ã‚­ãƒƒãƒ—
          continue;
        }
        
        // ğŸ”„ å¾“æ¥å½¢å¼ã®ãƒ‘ãƒ¼ã‚µãƒ¼ï¼ˆã‚³ãƒ­ãƒ³åŒºåˆ‡ã‚Šå½¢å¼ï¼‰
        // ãƒ‘ã‚¿ãƒ¼ãƒ³1: å…¨è§’ã‚³ãƒ­ãƒ³ï¼ˆï¼šï¼‰ã§åˆ†å‰²
        if (line.includes('ï¼š')) {
          const parts = line.split('ï¼š');
          exerciseName = parts[0].trim();
          dataStr = parts[1].trim();
        }
        // ãƒ‘ã‚¿ãƒ¼ãƒ³2: åŠè§’ã‚³ãƒ­ãƒ³ï¼ˆ:ï¼‰ã§åˆ†å‰²
        else if (line.includes(':')) {
          const parts = line.split(':');
          exerciseName = parts[0].trim();
          dataStr = parts[1].trim();
        }
        // ãƒ‘ã‚¿ãƒ¼ãƒ³3: æ•°å­—ã‚„kgãŒå‡ºç¾ã™ã‚‹å‰ã¾ã§ã‚’ç¨®ç›®åã¨ã™ã‚‹
        else {
          const match = line.match(/^([^0-9ï¼ˆ(]+)/);
          if (match) {
            exerciseName = match[1].trim();
            dataStr = line.substring(match[0].length).trim();
          }
        }
        
        if (!exerciseName) continue;
        
        // ç•ªå·ã‚’å‰Šé™¤: "1. ãƒãƒ¼ãƒ™ãƒ«ãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ" â†’ "ãƒãƒ¼ãƒ™ãƒ«ãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ"
        exerciseName = exerciseName.replace(/^\d+\.\s*/, '');
        
        // ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã‚’åˆ†å‰²ï¼ˆã€Œã€ã€ã¨ã€Œ,ã€ã¨ã€Œï¼ã€ã§åˆ†å‰²ï¼‰
        const setGroups = dataStr.split(/[,ã€ï¼/]/).map(s => s.trim()).filter(s => s);
        const allSets = [];
        
        for (const setGroup of setGroups) {
          // è‡ªé‡ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã‚¹ãƒšãƒ¼ã‚¹å¯¾å¿œï¼‰
          if (/è‡ªé‡/.test(setGroup)) {
            // ãƒ‘ã‚¿ãƒ¼ãƒ³1: è‡ªé‡ Ã— 10å› Ã— 3ã‚»ãƒƒãƒˆ
            const match1 = setGroup.match(/è‡ªé‡\s*[Ã—xX]\s*(\d+)\s*(?:å›|rep)?\s*[Ã—xX]\s*(\d+)\s*(?:ã‚»ãƒƒãƒˆ|set)?/i);
            if (match1) {
              const [, reps, sets] = match1;
              for (let i = 0; i < parseInt(sets); i++) {
                allSets.push({ reps: parseInt(reps) });
              }
              continue;
            }
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³2: è‡ªé‡ Ã— 10å›ï¼ˆã‚»ãƒƒãƒˆæ•°ãªã—ï¼‰
            const match2 = setGroup.match(/è‡ªé‡\s*[Ã—xX]\s*(\d+)\s*(?:å›|rep)?/i);
            if (match2) {
              const [, reps] = match2;
              allSets.push({ reps: parseInt(reps) });
              continue;
            }
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³3: è‡ªé‡ï¼ˆå›æ•°ã‚‚ãªã—ï¼‰
            allSets.push({ reps: 0 });
            continue;
          }
          
          // æ™‚é–“ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã‚¹ãƒšãƒ¼ã‚¹å¯¾å¿œï¼‰
          const timeMatch = setGroup.match(/(\d+)\s*ç§’\s*[Ã—xX]\s*(\d+)\s*(?:ã‚»ãƒƒãƒˆ|set)?/i);
          if (timeMatch) {
            const [, duration, sets] = timeMatch;
            for (let i = 0; i < parseInt(sets); i++) {
              allSets.push({ duration: parseInt(duration) });
            }
            continue;
          }
          
          // ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã‚¹ãƒšãƒ¼ã‚¹å¯¾å¿œï¼‰
          const warmupMatch = setGroup.match(/[ï¼ˆ(]\s*(?:WU|ã‚¦ã‚©ãƒ¼ãƒ )\s*[ï¼‰)]\s*([0-9.]+)\s*kg\s*[Ã—xX]\s*(\d+)\s*(?:å›|rep)?\s*[Ã—xX]\s*(\d+)\s*(?:ã‚»ãƒƒãƒˆ|set)?/i);
          if (warmupMatch) {
            const [, weight, reps, sets] = warmupMatch;
            for (let i = 0; i < parseInt(sets); i++) {
              allSets.push({ 
                weight: parseFloat(weight), 
                reps: parseInt(reps),
                type: 'warmup'
              });
            }
            continue;
          }
          
          // é€šå¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã‚¹ãƒšãƒ¼ã‚¹å¯¾å¿œ + ã‚ˆã‚ŠæŸ”è»Ÿã«ï¼‰
          // ãƒ‘ã‚¿ãƒ¼ãƒ³1: 80kg Ã— 8å› Ã— 3ã‚»ãƒƒãƒˆ
          const normalMatch1 = setGroup.match(/([0-9.]+)\s*kg\s*[Ã—xX]\s*(\d+)\s*(?:å›|rep)?\s*[Ã—xX]\s*(\d+)\s*(?:ã‚»ãƒƒãƒˆ|set)?/i);
          if (normalMatch1) {
            const [, weight, reps, sets] = normalMatch1;
            for (let i = 0; i < parseInt(sets); i++) {
              allSets.push({ 
                weight: parseFloat(weight), 
                reps: parseInt(reps)
              });
            }
            continue;
          }
          
          // ãƒ‘ã‚¿ãƒ¼ãƒ³2: 80kg Ã— 8å›ï¼ˆã‚»ãƒƒãƒˆæ•°ãªã—ï¼‰
          const normalMatch2 = setGroup.match(/([0-9.]+)\s*kg\s*[Ã—xX]\s*(\d+)\s*(?:å›|rep)?/i);
          if (normalMatch2) {
            const [, weight, reps] = normalMatch2;
            allSets.push({ 
              weight: parseFloat(weight), 
              reps: parseInt(reps)
            });
            continue;
          }
          
          // æ‹¬å¼§ã®ã¿ã®è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
          if (/^[ï¼ˆ(].*[ï¼‰)]$/.test(setGroup)) {
            continue;
          }
        }
        
        if (allSets.length > 0) {
          // ç¨®ç›®åã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆã€Œï¼è„šã€ãªã©ã®ä¸è¦éƒ¨åˆ†ã‚’å‰Šé™¤ï¼‰
          let cleanName = exerciseName.replace(/[ï¼/]è„š.*$/, '').trim();
          
          // ã€Œã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ»ã€ãªã©ã®æ¥é ­è¾ã‚’å‰Šé™¤
          cleanName = cleanName.replace(/^ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰[ãƒ»ï½¥]?/i, '');
          
          exercises.push({
            name: cleanName,
            sets: allSets
          });
        }
      }
      
      // ğŸ”š æœ€å¾Œã®ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºã‚’è¿½åŠ ï¼ˆHEVYã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå½¢å¼ç”¨ï¼‰
      if (currentExercise && currentExercise.sets.length > 0) {
        // ç¨®ç›®åã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        let cleanName = currentExercise.name.replace(/[ï¼/]è„š.*$/, '').trim();
        cleanName = cleanName.replace(/^ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰[ãƒ»ï½¥]?/i, '');
        
        exercises.push({
          name: cleanName,
          sets: currentExercise.sets
        });
      }
      
      return { date: currentDate, totalTime, exercises };
    }
    
    function fillFormWithData(data) {
      exList.innerHTML = '';
      
      const mainExercise = data.exercises[0]?.name || 'ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆ';
      document.getElementById('title').value = mainExercise + ' - ' + data.date;
      
      if (data.date) {
        const dateMatch = data.date.match(/(\d{1,2})\/(\d{1,2})/);
        if (dateMatch) {
          const year = new Date().getFullYear();
          const month = String(dateMatch[1]).padStart(2, '0');
          const day = String(dateMatch[2]).padStart(2, '0');
          
          document.getElementById('startTime').value = `${year}-${month}-${day}T09:00`;
          
          if (data.totalTime > 0) {
            const endDate = new Date(`${year}-${month}-${day}T09:00`);
            endDate.setMinutes(endDate.getMinutes() + data.totalTime);
            // JSTæ™‚åˆ»ã‚’ãƒ­ãƒ¼ã‚«ãƒ«å½¢å¼ã§å–å¾—ï¼ˆUTCå¤‰æ›ã—ãªã„ï¼‰
            const endYear = endDate.getFullYear();
            const endMonth = String(endDate.getMonth() + 1).padStart(2, '0');
            const endDay = String(endDate.getDate()).padStart(2, '0');
            const endHour = String(endDate.getHours()).padStart(2, '0');
            const endMinute = String(endDate.getMinutes()).padStart(2, '0');
            const endStr = `${endYear}-${endMonth}-${endDay}T${endHour}:${endMinute}`;
            document.getElementById('endTime').value = endStr;
            console.log(`â±ï¸ çµ‚äº†æ™‚åˆ»ã‚’è¨­å®š: ${endStr} (é–‹å§‹ + ${data.totalTime}åˆ†)`);
          } else {
            document.getElementById('endTime').value = `${year}-${month}-${day}T10:30`;
          }
        }
      } else {
        // ğŸ“… æ—¥ä»˜ãŒç„¡ã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ™‚åˆ»ã‚’è¨­å®šï¼ˆä»Šæ—¥ã®æ—¥ä»˜ã§9:00é–‹å§‹ï¼‰
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        document.getElementById('startTime').value = `${year}-${month}-${day}T09:00`;
        
        // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ™‚é–“ãŒã‚ã‚‹å ´åˆã¯åŠ ç®—ã€ãªã‘ã‚Œã°10:30
        if (data.totalTime > 0) {
          const endDate = new Date(`${year}-${month}-${day}T09:00`);
          endDate.setMinutes(endDate.getMinutes() + data.totalTime);
          const endYear = endDate.getFullYear();
          const endMonth = String(endDate.getMonth() + 1).padStart(2, '0');
          const endDay = String(endDate.getDate()).padStart(2, '0');
          const endHour = String(endDate.getHours()).padStart(2, '0');
          const endMinute = String(endDate.getMinutes()).padStart(2, '0');
          const endStr = `${endYear}-${endMonth}-${endDay}T${endHour}:${endMinute}`;
          document.getElementById('endTime').value = endStr;
          console.log(`â±ï¸ çµ‚äº†æ™‚åˆ»ã‚’è¨­å®š: ${endStr} (é–‹å§‹ + ${data.totalTime}åˆ†)`);
        } else {
          document.getElementById('endTime').value = `${year}-${month}-${day}T10:30`;
        }
      }
      
      data.exercises.forEach(ex => {
        const node = exTpl.content.firstElementChild.cloneNode(true);
        const setsWrap = node.querySelector('.sets');
        
        node.querySelector('.exNote').value = ex.name;
        node.dataset.exerciseName = ex.name;
        
        ex.sets.forEach(set => {
          const s = setTpl.content.firstElementChild.cloneNode(true);
          if (set.weight) s.querySelector('.w').value = set.weight;
          if (set.reps) s.querySelector('.r').value = set.reps;
          if (set.duration) s.querySelector('.dur').value = set.duration;
          if (set.type) s.querySelector('.type').value = set.type;
          setsWrap.appendChild(s);
        });
        
        exList.appendChild(node);
      });
      
      return data.exercises.length;
    }
    
    async function parseAndFill() {
      const rawText = document.getElementById('rawData').value;
      if (!rawText.trim()) {
        alert('ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      try {
        const data = parseWorkoutData(rawText);
        
        console.log('è§£æçµæœ:', data);
        console.log('ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºæ•°:', data.exercises.length);
        data.exercises.forEach((ex, i) => {
          console.log(`${i+1}. ${ex.name} - ã‚»ãƒƒãƒˆæ•°: ${ex.sets.length}`);
        });
        
        // ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºãŒ0ä»¶ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
        if (data.exercises.length === 0) {
          const info = document.getElementById('parseInfo');
          info.style.display = 'block';
          info.innerHTML = `<div class="err">
            <p style="margin: 0 0 8px;"><strong>âŒ ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</strong></p>
            <p style="margin: 4px 0; font-size: 0.85rem;">å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã«ä»¥ä¸‹ã®æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼š</p>
            <ul style="margin: 8px 0; padding-left: 20px; font-size: 0.85rem;">
              <li>ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºåï¼ˆä¾‹ï¼šã‚¹ãƒŸã‚¹ãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆï¼‰</li>
              <li>é‡é‡ãƒ»å›æ•°ãƒ»ã‚»ãƒƒãƒˆæ•°ï¼ˆä¾‹ï¼š97.5kgÃ—6Ã—3ï¼‰</li>
            </ul>
            <p style="margin: 8px 0 0; font-size: 0.85rem; color: var(--muted);">ğŸ’¡ æ­£ã—ã„å½¢å¼ã®ä¾‹ï¼š</p>
            <pre style="margin: 8px 0; padding: 8px; background: #0e141b; border-radius: 6px; font-size: 0.75rem;">10/14
æ™‚é–“/ç¨®ç›®/åˆè¨ˆï¼š120åˆ†ï¼11ç¨®ç›®ï¼9,801kg
ãƒ¡ã‚¤ãƒ³ï¼š
ã‚¹ãƒŸã‚¹ãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ 97.5kgÃ—6Ã—3
ãƒ’ãƒƒãƒ—ã‚¹ãƒ©ã‚¹ãƒˆ 130kgÃ—10Ã—3
ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒ»ãƒãƒ  è‡ªé‡Ã—15Ã—2</pre>
            <p style="margin: 8px 0 0; font-size: 0.85rem; color: var(--acc);">ğŸ‘‰ ã¾ãŸã¯ã€ä¸‹ã®ã€Œæ‰‹å‹•ã§ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã€ã‚’ã”åˆ©ç”¨ãã ã•ã„</p>
          </div>`;
          return;
        }
        
        const count = fillFormWithData(data);
        
        const info = document.getElementById('parseInfo');
        info.style.display = 'block';
        info.innerHTML = `<p class="ok">âœ“ ${count}ç¨®ç›®ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚<br>ğŸ” <strong>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDã‚’è‡ªå‹•æ¤œç´¢ä¸­...</strong></p>`;
        
        await searchAndFillTemplateIds();
        
        document.getElementById('manualForm').scrollIntoView({ behavior: 'smooth' });
      } catch (e) {
        const info = document.getElementById('parseInfo');
        info.style.display = 'block';
        info.innerHTML = `<p class="err">âœ— ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}</p>`;
        console.error(e);
      }
    }
    
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDè‡ªå‹•æ¤œç´¢
    async function searchAndFillTemplateIds() {
      const info = document.getElementById('parseInfo');
      
      // ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¿½åŠ 
      console.log('\n=== searchAndFillTemplateIds å®Ÿè¡Œ ===');
      console.log('allTemplates.length:', allTemplates.length);
      console.log('allTemplates[0]:', allTemplates[0]);
      console.log('allTemplatesé…åˆ—ã®å‹:', Array.isArray(allTemplates));
      
      if (allTemplates.length === 0) {
        info.innerHTML += `<p class="err"><br>âš ï¸ APIã‚­ãƒ¼ã®æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>`;
        return;
      }
      
      const translateToEnglish = (japaneseText) => {
        const dictionary = {
          'ã‚¹ãƒŸã‚¹ãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Smith Machine Squat',
          'ã‚¹ãƒŸã‚¹ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Smith Machine Squat',
          'ãƒ«ãƒ¼ãƒãƒ‹ã‚¢ãƒ³ãƒ»ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ': 'Romanian Deadlift',
          'ãƒ«ãƒ¼ãƒãƒ‹ã‚¢ãƒ³ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ': 'Romanian Deadlift',
          'RDL': 'Romanian Deadlift',
          'ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹': 'Bench Press',
          'ãƒ’ãƒƒãƒ—ã‚¹ãƒ©ã‚¹ãƒˆ': 'Hip Thrust',
          'ãƒ’ãƒƒãƒ—ãƒ»ã‚¹ãƒ©ã‚¹ãƒˆ': 'Hip Thrust',
          'ãƒãƒ¼ãƒ™ãƒ«ãƒ»ãƒ’ãƒƒãƒ—ã‚¹ãƒ©ã‚¹ãƒˆ': 'Barbell Hip Thrust',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒ»ãƒãƒ ': 'Nordic Hamstring Curl',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒãƒ ': 'Nordic Hamstring Curl',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒ»ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚¹': 'Nordic Hamstring Curl',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚¹': 'Nordic Hamstring Curl',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒ»ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°': 'Nordic Hamstring Curl',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°': 'Nordic Hamstring Curl',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ã‚«ãƒ¼ãƒ«': 'Nordic Hamstring Curl',
          'ã‚µã‚¤ãƒ‰ãƒ»ãƒ’ãƒƒãƒ—ãƒªãƒ•ãƒˆ': 'Side Hip Raise',
          'ã‚µã‚¤ãƒ‰ãƒ’ãƒƒãƒ—ãƒªãƒ•ãƒˆ': 'Side Hip Raise',
          'ã‚µã‚¤ãƒ‰ãƒ¬ãƒƒã‚°ãƒ¬ã‚¤ã‚º': 'Side Leg Raise',
          'ç‰‡è„šãƒ»ã‚«ãƒ¼ãƒ•ãƒ¬ã‚¤ã‚º': 'Single Leg Calf Raise',
          'ç‰‡è„šã‚«ãƒ¼ãƒ•ãƒ¬ã‚¤ã‚º': 'Single Leg Calf Raise',
          'ç‰‡è„šã‚«ãƒ¼ãƒ•': 'Single Leg Calf Raise',
          'ã‚«ãƒ¼ãƒ•ãƒ¬ã‚¤ã‚º': 'Calf Raise',
          'ãƒ•ãƒ­ãƒ³ãƒˆãƒ»ãƒ—ãƒ©ãƒ³ã‚¯': 'Front Plank',
          'ãƒ•ãƒ­ãƒ³ãƒˆãƒ—ãƒ©ãƒ³ã‚¯': 'Front Plank',
          'ãƒ—ãƒ©ãƒ³ã‚¯': 'Plank',
          'ãƒ–ãƒ«ã‚¬ãƒªã‚¢ãƒ³ãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Bulgarian Split Squat',
          'ãƒ–ãƒ«ã‚¬ãƒªã‚¢ãƒ³ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Bulgarian Split Squat',
          'ãƒãƒ¼ãƒ™ãƒ«ãƒ»ãƒ•ãƒ­ãƒ³ãƒˆãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Barbell Front Squat',
          'ãƒãƒ¼ãƒ™ãƒ«ãƒ•ãƒ­ãƒ³ãƒˆã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Barbell Front Squat',
          'ãƒ•ãƒ­ãƒ³ãƒˆã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Front Squat',
          'ãƒãƒ¼ãƒ™ãƒ«ãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Barbell Squat',
          'ãƒãƒ¼ãƒ™ãƒ«ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Barbell Squat',
          'ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Squat',
          'ã‚´ãƒ–ãƒ¬ãƒƒãƒˆã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Goblet Squat',
          'ãƒãƒ³ã‚®ãƒ³ã‚°ãƒ»ãƒ‹ãƒ¼ãƒ¬ã‚¤ã‚º': 'Hanging Knee Raise',
          'ãƒãƒ³ã‚®ãƒ³ã‚°ãƒ‹ãƒ¼ãƒ¬ã‚¤ã‚º': 'Hanging Knee Raise',
          'ãƒ‹ãƒ¼ãƒ¬ã‚¤ã‚º': 'Knee Raise',
          'ã‚±ãƒ¼ãƒ–ãƒ«ãƒ»ã‚¦ãƒƒãƒ‰ãƒãƒ§ãƒƒãƒ—': 'Cable Wood Chop',
          'ã‚±ãƒ¼ãƒ–ãƒ«ã‚¦ãƒƒãƒ‰ãƒãƒ§ãƒƒãƒ—': 'Cable Wood Chop',
          'ã‚¦ãƒƒãƒ‰ãƒãƒ§ãƒƒãƒ—': 'Wood Chop',
          'ãƒãƒ³ãƒ‰ãƒ»ãƒ’ãƒƒãƒ—ã‚¢ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Hip Adduction Band',
          'ãƒ’ãƒƒãƒ—ã‚¢ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Hip Adduction',
          'ãƒ’ãƒƒãƒ—ãƒ»ã‚¢ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Hip Adduction',
          'ãƒãƒ³ãƒ‰ãƒ»ãƒ’ãƒƒãƒ—ã‚¢ãƒ–ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Hip Abduction Band',
          'ãƒ’ãƒƒãƒ—ã‚¢ãƒ–ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Hip Abduction',
          'ãƒ’ãƒƒãƒ—ãƒ»ã‚¢ãƒ–ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Hip Abduction',
          'è‚¡é–¢ç¯€ãƒãƒƒã‚¯ãƒ»ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³': 'Hip Extension',
          'ç‰‡è„šè‚¡é–¢ç¯€ãƒãƒƒã‚¯ãƒ»ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³': 'Single Leg Hip Extension',
          'ã‚«ãƒ¼ãƒ•ãƒ¬ã‚¤ã‚ºï¼ˆãƒ¬ãƒƒã‚°ãƒ—ãƒ¬ã‚¹ï¼‰': 'Leg Press Calf Raise',
          'ãƒ¬ãƒƒã‚°ãƒ—ãƒ¬ã‚¹': 'Leg Press',
          'ãƒ¬ãƒƒã‚°ãƒ»ãƒ—ãƒ¬ã‚¹': 'Leg Press',
          'ãƒ¬ãƒƒã‚°ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³': 'Leg Extension',
          'ãƒ¬ãƒƒã‚°ãƒ»ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³': 'Leg Extension',
          'ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«': 'Leg Curl',
          'ãƒ¬ãƒƒã‚°ãƒ»ã‚«ãƒ¼ãƒ«': 'Leg Curl',
          'ãƒ©ã‚¤ã‚¤ãƒ³ã‚°ãƒ»ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«': 'Lying Leg Curl',
          'ãƒ©ã‚¤ã‚¤ãƒ³ã‚°ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«': 'Lying Leg Curl',
          'ã‚·ãƒ¼ãƒ†ãƒƒãƒ‰ãƒ»ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«': 'Seated Leg Curl',
          'ã‚·ãƒ¼ãƒ†ãƒƒãƒ‰ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«': 'Seated Leg Curl',
          'ã‚¹ã‚¿ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ»ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«': 'Standing Leg Curl',
          'ã‚¹ã‚¿ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«': 'Standing Leg Curl'
        };
        
        const cleaned = japaneseText.replace(/[ï¼ˆ(].*?[)ï¼‰]/g, '').trim();
        if (dictionary[cleaned]) {
          console.log(`    ğŸ“– è¾æ›¸ãƒãƒƒãƒ: "${cleaned}" â†’ "${dictionary[cleaned]}"`);
          return dictionary[cleaned];
        }
        
        let translated = japaneseText;
        const partialDict = {
          'ã‚¹ãƒŸã‚¹': 'Smith Machine', 'ãƒãƒ¼ãƒ™ãƒ«': 'Barbell', 'ãƒ€ãƒ³ãƒ™ãƒ«': 'Dumbbell',
          'ãƒã‚·ãƒ³': 'Machine', 'ã‚±ãƒ¼ãƒ–ãƒ«': 'Cable', 'ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Squat',
          'ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ': 'Deadlift', 'ãƒ™ãƒ³ãƒ': 'Bench', 'ãƒ—ãƒ¬ã‚¹': 'Press',
          'ãƒ—ãƒ©ãƒ³ã‚¯': 'Plank', 'ã‚«ãƒ¼ãƒ«': 'Curl', 'ãƒ¬ã‚¤ã‚º': 'Raise',
          'ãƒ­ã‚¦': 'Row', 'ãƒ—ãƒ«': 'Pull', 'ãƒ—ãƒƒã‚·ãƒ¥': 'Push',
          'ãƒªãƒ•ãƒˆ': 'Lift', 'ã‚¹ãƒ©ã‚¹ãƒˆ': 'Thrust', 'ãƒ’ãƒƒãƒ—': 'Hip',
          'ãƒ¬ãƒƒã‚°': 'Leg', 'ã‚«ãƒ¼ãƒ•': 'Calf', 'ãƒ•ãƒ­ãƒ³ãƒˆ': 'Front',
          'ã‚µã‚¤ãƒ‰': 'Side', 'ãƒãƒƒã‚¯': 'Back', 'ãƒ«ãƒ¼ãƒãƒ‹ã‚¢ãƒ³': 'Romanian',
          'ãƒ–ãƒ«ã‚¬ãƒªã‚¢ãƒ³': 'Bulgarian', 'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯': 'Nordic',
          'ç‰‡è„š': 'Single Leg', 'ä¸¡è„š': 'Double Leg', 'è‡ªé‡': 'Bodyweight',
          'ãƒãƒ³ã‚®ãƒ³ã‚°': 'Hanging', 'ãƒ‹ãƒ¼': 'Knee', 'ã‚¦ãƒƒãƒ‰': 'Wood',
          'ãƒãƒ§ãƒƒãƒ—': 'Chop', 'ãƒãƒ³ãƒ‰': 'Band', 'ã‚¢ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Adduction',
          'ã‚¢ãƒ–ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Abduction', 'ãƒ„ã‚¤ã‚¹ãƒˆ': 'Twist',
          'ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚¹': 'Hamstring', 'ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°': 'Hamstring'
        };
        
        for (const [jp, en] of Object.entries(partialDict)) {
          translated = translated.replace(new RegExp(jp, 'g'), en);
        }
        
        return translated.replace(/[ãƒ»ã€ã€‚]/g, ' ').replace(/\s+/g, ' ').trim();
      };
      
      let matchCount = 0;
      const exercises = exList.querySelectorAll('.exercise');
      
      exercises.forEach((exNode, index) => {
        const exerciseName = exNode.dataset.exerciseName;
        if (!exerciseName) return;
        
        console.log(`\n[${index + 1}] "${exerciseName}"`);
        
        // ğŸ§  å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å„ªå…ˆçš„ã«æ¤œç´¢
        const learned = getLearnedTemplate(exerciseName);
        if (learned) {
          console.log(`  ğŸ§  å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è‡ªå‹•å…¥åŠ›: "${learned.title}" (ID: ${learned.id})`);
          const tplIdInput = exNode.querySelector('.tplId');
          tplIdInput.value = learned.id;
          tplIdInput.style.borderColor = '#15c27a';
          tplIdInput.style.background = '#0a2a1a';
          matchCount++;
          return; // å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ç¿»è¨³ãƒ»æ¤œç´¢ã‚’ã‚¹ã‚­ãƒƒãƒ—
        }
        
        const translatedName = translateToEnglish(exerciseName);
        console.log(`  â†’ ç¿»è¨³: "${translatedName}"`);
        
        const calculateMatchScore = (translatedName, templateTitle) => {
          const normalizedTitle = templateTitle.replace(/[ï¼ˆ(].*?[)ï¼‰]/g, '').toLowerCase().replace(/[\s\-ãƒ»()ï¼ˆï¼‰]/g, '');
          const normalizedSearch = translatedName.replace(/[ï¼ˆ(].*?[)ï¼‰]/g, '').toLowerCase().replace(/[\s\-ãƒ»()ï¼ˆï¼‰]/g, '');
          const translatedLower = translatedName.toLowerCase();
          const titleLower = templateTitle.toLowerCase();
          const titleWithoutParens = templateTitle.replace(/[ï¼ˆ(].*?[)ï¼‰]/g, '').toLowerCase().trim();
          
          // ğŸ¯ å®Œå…¨ä¸€è‡´ï¼ˆæ‹¬å¼§å†…ã‚’å«ã‚€ï¼‰= 1100ç‚¹
          if (titleLower === translatedLower) {
            return { score: 1100, reason: 'å®Œå…¨ä¸€è‡´ï¼ˆæ‹¬å¼§å«ã‚€ï¼‰', title: templateTitle };
          }
          
          // å®Œå…¨ä¸€è‡´ = 1000ç‚¹
          if (normalizedTitle === normalizedSearch) {
            return { score: 1000, reason: 'å®Œå…¨ä¸€è‡´', title: templateTitle };
          }
          
          // æ­£è¦åŒ–å¾Œã®å®Œå…¨ä¸€è‡´ï¼ˆæ‹¬å¼§é™¤å¤–ï¼‰
          if (titleWithoutParens.replace(/[\s\-]/g, '') === translatedLower.replace(/[\s\-]/g, '')) {
            return { score: 950, reason: 'å®Œå…¨ä¸€è‡´ï¼ˆæ‹¬å¼§é™¤å¤–ï¼‰', title: templateTitle };
          }
          
          // éƒ¨åˆ†ä¸€è‡´ï¼ˆæ­£è¦åŒ–å¾Œã«ç‰‡æ–¹ãŒå®Œå…¨ã«å«ã¾ã‚Œã‚‹ï¼‰
          if (normalizedTitle.includes(normalizedSearch) || normalizedSearch.includes(normalizedTitle)) {
            return { score: 900, reason: 'éƒ¨åˆ†ä¸€è‡´ï¼ˆæ­£è¦åŒ–ï¼‰', title: templateTitle };
          }
          
          // ç¿»è¨³åã§ã®éƒ¨åˆ†ä¸€è‡´ï¼ˆæ‹¬å¼§é™¤å¤–ï¼‰
          if (titleWithoutParens.includes(translatedLower) || translatedLower.includes(titleWithoutParens)) {
            return { score: 850, reason: 'ç¿»è¨³åä¸€è‡´ï¼ˆæ‹¬å¼§é™¤å¤–ï¼‰', title: templateTitle };
          }
          
          // ğŸ” å˜èªå˜ä½ã§ã®ãƒãƒƒãƒãƒ³ã‚°ï¼ˆæœ€å°é•·ã‚’2æ–‡å­—ã«ç·©å’Œï¼‰
          const translatedWords = translatedName.toLowerCase().split(/[\s\-]+/).filter(w => w.length >= 2);
          const titleWords = templateTitle.replace(/[ï¼ˆ(].*?[)ï¼‰]/g, '').toLowerCase().split(/[\s\-]+/).filter(w => w.length >= 2);
          
          if (translatedWords.length === 0 || titleWords.length === 0) {
            return { score: 0, reason: 'ãªã—', title: templateTitle };
          }
          
          // å®Œå…¨ä¸€è‡´ã™ã‚‹å˜èªã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          const exactMatches = translatedWords.filter(w => titleWords.includes(w));
          const matchRatio = exactMatches.length / translatedWords.length;
          
          // ğŸ¯ å…¨å˜èªãŒä¸€è‡´ & å˜èªæ•°ã‚‚ä¸€è‡´ï¼ˆé †åºã¯å•ã‚ãªã„ï¼‰= 975ç‚¹
          if (matchRatio === 1.0 && exactMatches.length === titleWords.length && exactMatches.length >= 2) {
            return { score: 975, reason: `å®Œå…¨å˜èªä¸€è‡´(${exactMatches.length}å˜èª)`, title: templateTitle };
          }
          
          // å…¨å˜èªãŒä¸€è‡´ã™ã‚‹å ´åˆã®ã¿é«˜ã‚¹ã‚³ã‚¢
          if (matchRatio === 1.0 && exactMatches.length >= 2) {
            return { score: 800, reason: `å…¨å˜èªä¸€è‡´(${exactMatches.length}/${translatedWords.length})`, title: templateTitle };
          }
          
          // 75%ä»¥ä¸Šã®å˜èªãŒä¸€è‡´
          if (matchRatio >= 0.75 && exactMatches.length >= 2) {
            return { score: 700, reason: `é«˜å˜èªä¸€è‡´ç‡(${exactMatches.length}/${translatedWords.length})`, title: templateTitle };
          }
          
          // 50%ä»¥ä¸Šã®å˜èªãŒä¸€è‡´
          if (matchRatio >= 0.5 && exactMatches.length >= 2) {
            return { score: 500, reason: `ä¸­å˜èªä¸€è‡´ç‡(${exactMatches.length}/${translatedWords.length})`, title: templateTitle };
          }
          
          // ğŸ¯ éƒ¨åˆ†ä¸€è‡´ï¼ˆå˜èªã®ä¸€éƒ¨ãŒå«ã¾ã‚Œã‚‹ï¼‰
          const partialMatches = translatedWords.filter(w => 
            titleWords.some(tw => tw.includes(w) || w.includes(tw))
          );
          if (partialMatches.length >= 2) {
            return { score: 400, reason: `éƒ¨åˆ†å˜èªä¸€è‡´(${partialMatches.length}å˜èª)`, title: templateTitle };
          }
          if (partialMatches.length === 1) {
            return { score: 300, reason: `éƒ¨åˆ†å˜èªä¸€è‡´(1å˜èª)`, title: templateTitle };
          }
          
          // ğŸ¯ å˜ä¸€å˜èªã®ã¿ã®ä¸€è‡´ï¼ˆ1å˜èªã§ã‚‚å€™è£œã¨ã—ã¦è¡¨ç¤ºï¼‰
          if (exactMatches.length === 1) {
            return { score: 250, reason: `å˜èªä¸€è‡´(1å˜èª)`, title: templateTitle };
          }
          
          return { score: 0, reason: 'ãªã—', title: templateTitle };
        };
        
        // ğŸ” æ¤œç´¢å¯¾è±¡ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã‹ã‚‰ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼ˆæœ€å°é•·1æ–‡å­—ï¼‰
        const searchKeywords = translatedName.toLowerCase().split(/[\s\-]+/).filter(w => w.length >= 1);
        console.log(`  ğŸ” æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: [${searchKeywords.join(', ')}]`);
        
        // ã¾ãšéƒ¨åˆ†ä¸€è‡´ã§å€™è£œã‚’çµã‚Šè¾¼ã‚€
        const relevantTemplates = allTemplates.filter(t => {
          const titleLower = t.title.toLowerCase();
          return searchKeywords.some(keyword => titleLower.includes(keyword));
        });
        
        console.log(`  ğŸ” é–¢é€£å€™è£œ: ${relevantTemplates.length}ä»¶ â†’ ${relevantTemplates.slice(0, 5).map(t => t.title).join(', ')}`);
        
        const scoredTemplates = relevantTemplates.map(t => {
          const score = calculateMatchScore(translatedName, t.title);
          console.log(`    "${t.title}" â†’ ${score.score}ç‚¹ (${score.reason})`);
          return {
            template: t,
            ...score
          };
        }).filter(item => item.score > 0).sort((a, b) => b.score - a.score);
        
        console.log(`  âœ… æœ€çµ‚å€™è£œæ•°: ${scoredTemplates.length}`);
        
        if (scoredTemplates.length > 0) {
          const best = scoredTemplates[0];
          console.log(`  â†’ ãƒ™ã‚¹ãƒˆãƒãƒƒãƒ: "${best.title}" (${best.score}ç‚¹: ${best.reason})`);
          
          if (best.score >= 800) {
            const match = best.template;
            const tplIdInput = exNode.querySelector('.tplId');
            tplIdInput.value = match.id;
            tplIdInput.style.borderColor = '#15c27a';
            tplIdInput.style.background = '#0a2a1a';
            console.log(`  â†’ âœ… è‡ªå‹•å…¥åŠ›: ${match.id}`);
            matchCount++;
          } else {
            // ğŸ’ 800ç‚¹æœªæº€ã§ã‚‚ãƒˆãƒƒãƒ—10å€™è£œã‚’è¡¨ç¤º
            console.log(`  â†’ ğŸ’ ã‚¹ã‚³ã‚¢ä¸è¶³ (${best.score} < 800) - å€™è£œã‚’è¡¨ç¤º`);
            showInlineSuggestions(exNode, exerciseName, scoredTemplates);
          }
        } else {
          console.log(`  â†’ âŒ ãƒãƒƒãƒãªã— - æ‰‹å‹•æ¤œç´¢ã‚’ãŠè©¦ã—ãã ã•ã„ï¼ˆğŸ”ãƒœã‚¿ãƒ³ï¼‰`);
        }
      });
      
      if (matchCount > 0) {
        info.innerHTML = `<div class="success-box"><p class="ok" style="margin: 0;">âœ“ ${matchCount}/${exercises.length}ç¨®ç›®ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDã‚’è‡ªå‹•å…¥åŠ›ã—ã¾ã—ãŸ</p></div>`;
      } else {
        info.innerHTML = `<p class="err">âš ï¸ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>`;
      }
    }
    
    // ğŸ’ ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å€™è£œè¡¨ç¤ºæ©Ÿèƒ½
    function showInlineSuggestions(exNode, exerciseName, scoredTemplates) {
      const container = exNode.querySelector('.inline-suggestions-container');
      if (!container) return;
      
      const topCandidates = scoredTemplates.slice(0, 10);  // 5ä»¶ â†’ 10ä»¶ã«å¢—åŠ 
      
      if (topCandidates.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      let html = '<div class="inline-suggestions">';
      html += '<div style="font-size:0.8rem; color:var(--muted); margin-bottom:6px;">ğŸ’¡ å€™è£œï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é¸æŠï¼‰:</div>';
      
      topCandidates.forEach(item => {
        html += `
          <div class="inline-suggestion-item" onclick="selectTemplate(this, '${item.template.id}', '${item.template.title.replace(/'/g, "\\'")}', '${exerciseName.replace(/'/g, "\\'")}')">
            <span>${item.template.title}</span>
            <span style="color:var(--muted); font-size:0.75rem;">${item.score}ç‚¹ (${item.reason})</span>
          </div>
        `;
      });
      
      // ã‚‚ã£ã¨æ¤œç´¢ãƒœã‚¿ãƒ³
      if (scoredTemplates.length > 10) {
        html += `
          <button type="button" class="btn ghost" style="width:100%; margin-top:6px; font-size:0.75rem;" 
                  onclick="showExpandedSearch(this, '${exerciseName.replace(/'/g, "\\'")}')">
            ğŸ” ã‚‚ã£ã¨æ¤œç´¢ (æ®‹ã‚Š${scoredTemplates.length - 10}ä»¶)
          </button>
        `;
      }
      
      html += '</div>';
      container.innerHTML = html;
    }
    
    // ğŸ” å€™è£œé¸æŠæ™‚ã®å‡¦ç†
    function selectTemplate(element, templateId, templateTitle, exerciseName) {
      const exNode = element.closest('.exercise');
      const tplIdInput = exNode.querySelector('.tplId');
      
      // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDã‚’å…¥åŠ›
      tplIdInput.value = templateId;
      tplIdInput.style.borderColor = '#15c27a';
      tplIdInput.style.background = '#0a2a1a';
      
      // ğŸ§  å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿å­˜
      saveLearnedMapping(exerciseName, templateId, templateTitle);
      
      // å€™è£œãƒªã‚¹ãƒˆã‚’éè¡¨ç¤º
      const container = exNode.querySelector('.inline-suggestions-container');
      if (container) {
        container.innerHTML = '<div style="font-size:0.8rem; color:var(--ok); padding:8px;">âœ“ é¸æŠæ¸ˆã¿: ' + templateTitle + ' ğŸ§ å­¦ç¿’æ¸ˆã¿</div>';
      }
      
      console.log(`âœ… é¸æŠ: "${exerciseName}" â†’ "${templateTitle}" (ID: ${templateId})`);
    }
    
    // ğŸ” æ‰‹å‹•æ¤œç´¢ï¼ˆğŸ”ãƒœã‚¿ãƒ³ï¼‰
    function searchInline(buttonElement) {
      const exNode = buttonElement.closest('.exercise');
      const exerciseName = exNode.querySelector('.exNote').value.trim() || exNode.dataset.exerciseName;
      
      if (!exerciseName) {
        alert('ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      if (allTemplates.length === 0) {
        alert('å…ˆã«APIã‚­ãƒ¼ã®æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
        return;
      }
      
      console.log(`ğŸ” ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æ¤œç´¢: "${exerciseName}"`);
      
      // ç¿»è¨³è¾æ›¸ï¼ˆsearchAndFillTemplateIdså†…ã¨åŒã˜ã‚‚ã®ï¼‰
      const translateToEnglish = (japaneseText) => {
        const dictionary = {
          'ã‚¹ãƒŸã‚¹ãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Smith Machine Squat',
          'ã‚¹ãƒŸã‚¹ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Smith Machine Squat',
          'ãƒ«ãƒ¼ãƒãƒ‹ã‚¢ãƒ³ãƒ»ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ': 'Romanian Deadlift',
          'ãƒ«ãƒ¼ãƒãƒ‹ã‚¢ãƒ³ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ': 'Romanian Deadlift',
          'RDL': 'Romanian Deadlift',
          'ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹': 'Bench Press',
          'ãƒ’ãƒƒãƒ—ã‚¹ãƒ©ã‚¹ãƒˆ': 'Hip Thrust',
          'ãƒ’ãƒƒãƒ—ãƒ»ã‚¹ãƒ©ã‚¹ãƒˆ': 'Hip Thrust',
          'ãƒãƒ¼ãƒ™ãƒ«ãƒ»ãƒ’ãƒƒãƒ—ã‚¹ãƒ©ã‚¹ãƒˆ': 'Barbell Hip Thrust',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒ»ãƒãƒ ': 'Nordic Hamstring Curl',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒãƒ ': 'Nordic Hamstring Curl',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒ»ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚¹': 'Nordic Hamstring Curl',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚¹': 'Nordic Hamstring Curl',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒ»ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°': 'Nordic Hamstring Curl',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°': 'Nordic Hamstring Curl',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ã‚«ãƒ¼ãƒ«': 'Nordic Hamstring Curl',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒ»ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚¹': 'Nordic Hamstring Curl',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚¹': 'Nordic Hamstring Curl',
          'ã‚µã‚¤ãƒ‰ãƒ»ãƒ’ãƒƒãƒ—ãƒªãƒ•ãƒˆ': 'Side Hip Raise',
          'ã‚µã‚¤ãƒ‰ãƒ’ãƒƒãƒ—ãƒªãƒ•ãƒˆ': 'Side Hip Raise',
          'ã‚µã‚¤ãƒ‰ãƒ¬ãƒƒã‚°ãƒ¬ã‚¤ã‚º': 'Side Leg Raise',
          'ç‰‡è„šãƒ»ã‚«ãƒ¼ãƒ•ãƒ¬ã‚¤ã‚º': 'Single Leg Calf Raise',
          'ç‰‡è„šã‚«ãƒ¼ãƒ•ãƒ¬ã‚¤ã‚º': 'Single Leg Calf Raise',
          'ç‰‡è„šã‚«ãƒ¼ãƒ•': 'Single Leg Calf Raise',
          'ã‚«ãƒ¼ãƒ•ãƒ¬ã‚¤ã‚º': 'Calf Raise',
          'ãƒ•ãƒ­ãƒ³ãƒˆãƒ»ãƒ—ãƒ©ãƒ³ã‚¯': 'Front Plank',
          'ãƒ•ãƒ­ãƒ³ãƒˆãƒ—ãƒ©ãƒ³ã‚¯': 'Front Plank',
          'ãƒ—ãƒ©ãƒ³ã‚¯': 'Plank',
          'ãƒ–ãƒ«ã‚¬ãƒªã‚¢ãƒ³ãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Bulgarian Split Squat',
          'ãƒ–ãƒ«ã‚¬ãƒªã‚¢ãƒ³ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Bulgarian Split Squat',
          'ãƒãƒ¼ãƒ™ãƒ«ãƒ»ãƒ•ãƒ­ãƒ³ãƒˆãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Barbell Front Squat',
          'ãƒãƒ¼ãƒ™ãƒ«ãƒ•ãƒ­ãƒ³ãƒˆã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Barbell Front Squat',
          'ãƒ•ãƒ­ãƒ³ãƒˆã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Front Squat',
          'ãƒãƒ¼ãƒ™ãƒ«ãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Barbell Squat',
          'ãƒãƒ¼ãƒ™ãƒ«ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Barbell Squat',
          'ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Squat',
          'ã‚´ãƒ–ãƒ¬ãƒƒãƒˆã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Goblet Squat',
          'ãƒãƒ³ã‚®ãƒ³ã‚°ãƒ»ãƒ‹ãƒ¼ãƒ¬ã‚¤ã‚º': 'Hanging Knee Raise',
          'ãƒãƒ³ã‚®ãƒ³ã‚°ãƒ‹ãƒ¼ãƒ¬ã‚¤ã‚º': 'Hanging Knee Raise',
          'ãƒ‹ãƒ¼ãƒ¬ã‚¤ã‚º': 'Knee Raise',
          'ã‚±ãƒ¼ãƒ–ãƒ«ãƒ»ã‚¦ãƒƒãƒ‰ãƒãƒ§ãƒƒãƒ—': 'Cable Wood Chop',
          'ã‚±ãƒ¼ãƒ–ãƒ«ã‚¦ãƒƒãƒ‰ãƒãƒ§ãƒƒãƒ—': 'Cable Wood Chop',
          'ã‚¦ãƒƒãƒ‰ãƒãƒ§ãƒƒãƒ—': 'Wood Chop',
          'ãƒãƒ³ãƒ‰ãƒ»ãƒ’ãƒƒãƒ—ã‚¢ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Hip Adduction Band',
          'ãƒ’ãƒƒãƒ—ã‚¢ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Hip Adduction',
          'ãƒ’ãƒƒãƒ—ãƒ»ã‚¢ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Hip Adduction',
          'ãƒãƒ³ãƒ‰ãƒ»ãƒ’ãƒƒãƒ—ã‚¢ãƒ–ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Hip Abduction Band',
          'ãƒ’ãƒƒãƒ—ã‚¢ãƒ–ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Hip Abduction',
          'ãƒ’ãƒƒãƒ—ãƒ»ã‚¢ãƒ–ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Hip Abduction',
          'è‚¡é–¢ç¯€ãƒãƒƒã‚¯ãƒ»ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³': 'Hip Extension',
          'ç‰‡è„šè‚¡é–¢ç¯€ãƒãƒƒã‚¯ãƒ»ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³': 'Single Leg Hip Extension',
          'ã‚«ãƒ¼ãƒ•ãƒ¬ã‚¤ã‚ºï¼ˆãƒ¬ãƒƒã‚°ãƒ—ãƒ¬ã‚¹ï¼‰': 'Leg Press Calf Raise',
          'ãƒ¬ãƒƒã‚°ãƒ—ãƒ¬ã‚¹': 'Leg Press',
          'ãƒ¬ãƒƒã‚°ãƒ»ãƒ—ãƒ¬ã‚¹': 'Leg Press',
          'ãƒ¬ãƒƒã‚°ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³': 'Leg Extension',
          'ãƒ¬ãƒƒã‚°ãƒ»ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³': 'Leg Extension',
          'ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«': 'Leg Curl',
          'ãƒ¬ãƒƒã‚°ãƒ»ã‚«ãƒ¼ãƒ«': 'Leg Curl',
          'ãƒ©ã‚¤ã‚¤ãƒ³ã‚°ãƒ»ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«': 'Lying Leg Curl',
          'ãƒ©ã‚¤ã‚¤ãƒ³ã‚°ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«': 'Lying Leg Curl',
          'ã‚·ãƒ¼ãƒ†ãƒƒãƒ‰ãƒ»ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«': 'Seated Leg Curl',
          'ã‚·ãƒ¼ãƒ†ãƒƒãƒ‰ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«': 'Seated Leg Curl',
          'ã‚¹ã‚¿ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ»ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«': 'Standing Leg Curl',
          'ã‚¹ã‚¿ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«': 'Standing Leg Curl'
        };
        
        const cleaned = japaneseText.replace(/[ï¼ˆ(].*?[)ï¼‰]/g, '').trim();
        if (dictionary[cleaned]) {
          console.log(`    ğŸ“– è¾æ›¸ãƒãƒƒãƒ: "${cleaned}" â†’ "${dictionary[cleaned]}"`);
          return dictionary[cleaned];
        }
        
        let translated = japaneseText;
        const partialDict = {
          'ã‚¹ãƒŸã‚¹': 'Smith Machine', 'ãƒãƒ¼ãƒ™ãƒ«': 'Barbell', 'ãƒ€ãƒ³ãƒ™ãƒ«': 'Dumbbell',
          'ãƒã‚·ãƒ³': 'Machine', 'ã‚±ãƒ¼ãƒ–ãƒ«': 'Cable', 'ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Squat',
          'ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ': 'Deadlift', 'ãƒ™ãƒ³ãƒ': 'Bench', 'ãƒ—ãƒ¬ã‚¹': 'Press',
          'ãƒ—ãƒ©ãƒ³ã‚¯': 'Plank', 'ã‚«ãƒ¼ãƒ«': 'Curl', 'ãƒ¬ã‚¤ã‚º': 'Raise',
          'ãƒ­ã‚¦': 'Row', 'ãƒ—ãƒ«': 'Pull', 'ãƒ—ãƒƒã‚·ãƒ¥': 'Push',
          'ãƒªãƒ•ãƒˆ': 'Lift', 'ã‚¹ãƒ©ã‚¹ãƒˆ': 'Thrust', 'ãƒ’ãƒƒãƒ—': 'Hip',
          'ãƒ¬ãƒƒã‚°': 'Leg', 'ã‚«ãƒ¼ãƒ•': 'Calf', 'ãƒ•ãƒ­ãƒ³ãƒˆ': 'Front',
          'ã‚µã‚¤ãƒ‰': 'Side', 'ãƒãƒƒã‚¯': 'Back', 'ãƒ«ãƒ¼ãƒãƒ‹ã‚¢ãƒ³': 'Romanian',
          'ãƒ–ãƒ«ã‚¬ãƒªã‚¢ãƒ³': 'Bulgarian', 'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯': 'Nordic',
          'ç‰‡è„š': 'Single Leg', 'ä¸¡è„š': 'Double Leg', 'è‡ªé‡': 'Bodyweight',
          'ãƒãƒ³ã‚®ãƒ³ã‚°': 'Hanging', 'ãƒ‹ãƒ¼': 'Knee', 'ã‚¦ãƒƒãƒ‰': 'Wood',
          'ãƒãƒ§ãƒƒãƒ—': 'Chop', 'ãƒãƒ³ãƒ‰': 'Band', 'ã‚¢ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Adduction',
          'ã‚¢ãƒ–ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Abduction', 'ãƒ„ã‚¤ã‚¹ãƒˆ': 'Twist',
          'ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚¹': 'Hamstring', 'ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°': 'Hamstring', 'ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚¹': 'Hamstring'
        };
        
        for (const [jp, en] of Object.entries(partialDict)) {
          translated = translated.replace(new RegExp(jp, 'g'), en);
        }
        
        return translated.replace(/[ãƒ»ã€ã€‚]/g, ' ').replace(/\s+/g, ' ').trim();
      };
      
      const translatedName = translateToEnglish(exerciseName);
      console.log(`   â†’ ç¿»è¨³: "${translatedName}"`);
      
      // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢
      const searchKeywords = translatedName.toLowerCase().split(/[\s\-]+/).filter(w => w.length >= 2);
      console.log(`   ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: [${searchKeywords.join(', ')}]`);
      
      const candidates = allTemplates.filter(t => {
        const titleLower = t.title.toLowerCase();
        return searchKeywords.some(keyword => titleLower.includes(keyword));
      }).slice(0, 30);
      
      if (candidates.length === 0) {
        alert(`"${exerciseName}" ã«ä¸€è‡´ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
        return;
      }
      
      // ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼ˆç°¡æ˜“ç‰ˆï¼‰
      const scoredTemplates = candidates.map(t => ({
        template: t,
        score: 500,
        reason: 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´',
        title: t.title
      }));
      
      showInlineSuggestions(exNode, exerciseName, scoredTemplates);
    }
    
    // ğŸ” æ‹¡å¼µæ¤œç´¢ï¼ˆã‚‚ã£ã¨æ¤œç´¢ãƒœã‚¿ãƒ³ï¼‰
    function showExpandedSearch(buttonElement, exerciseName) {
      const exNode = buttonElement.closest('.exercise');
      
      // ç¿»è¨³ã—ã¦å…¨å€™è£œã‚’å–å¾—
      const translateToEnglish = (japaneseText) => {
        const dictionary = {
          'ã‚¹ãƒŸã‚¹ãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Smith Machine Squat',
          'ã‚¹ãƒŸã‚¹ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Smith Machine Squat',
          'ãƒ«ãƒ¼ãƒãƒ‹ã‚¢ãƒ³ãƒ»ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ': 'Romanian Deadlift',
          'ãƒ«ãƒ¼ãƒãƒ‹ã‚¢ãƒ³ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ': 'Romanian Deadlift',
          'RDL': 'Romanian Deadlift',
          'ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹': 'Bench Press',
          'ãƒ’ãƒƒãƒ—ã‚¹ãƒ©ã‚¹ãƒˆ': 'Hip Thrust',
          'ãƒ’ãƒƒãƒ—ãƒ»ã‚¹ãƒ©ã‚¹ãƒˆ': 'Hip Thrust',
          'ãƒãƒ¼ãƒ™ãƒ«ãƒ»ãƒ’ãƒƒãƒ—ã‚¹ãƒ©ã‚¹ãƒˆ': 'Barbell Hip Thrust',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒ»ãƒãƒ ': 'Nordic Hamstring Curl',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒãƒ ': 'Nordic Hamstring Curl',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒ»ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚¹': 'Nordic Hamstring Curl',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚¹': 'Nordic Hamstring Curl',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒ»ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°': 'Nordic Hamstring Curl',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°': 'Nordic Hamstring Curl',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ã‚«ãƒ¼ãƒ«': 'Nordic Hamstring Curl',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒ»ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚¹': 'Nordic Hamstring Curl',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚¹': 'Nordic Hamstring Curl',
          'ã‚µã‚¤ãƒ‰ãƒ»ãƒ’ãƒƒãƒ—ãƒªãƒ•ãƒˆ': 'Side Hip Raise',
          'ã‚µã‚¤ãƒ‰ãƒ’ãƒƒãƒ—ãƒªãƒ•ãƒˆ': 'Side Hip Raise',
          'ã‚µã‚¤ãƒ‰ãƒ¬ãƒƒã‚°ãƒ¬ã‚¤ã‚º': 'Side Leg Raise',
          'ç‰‡è„šãƒ»ã‚«ãƒ¼ãƒ•ãƒ¬ã‚¤ã‚º': 'Single Leg Calf Raise',
          'ç‰‡è„šã‚«ãƒ¼ãƒ•ãƒ¬ã‚¤ã‚º': 'Single Leg Calf Raise',
          'ç‰‡è„šã‚«ãƒ¼ãƒ•': 'Single Leg Calf Raise',
          'ã‚«ãƒ¼ãƒ•ãƒ¬ã‚¤ã‚º': 'Calf Raise',
          'ãƒ•ãƒ­ãƒ³ãƒˆãƒ»ãƒ—ãƒ©ãƒ³ã‚¯': 'Front Plank',
          'ãƒ•ãƒ­ãƒ³ãƒˆãƒ—ãƒ©ãƒ³ã‚¯': 'Front Plank',
          'ãƒ—ãƒ©ãƒ³ã‚¯': 'Plank',
          'ãƒ–ãƒ«ã‚¬ãƒªã‚¢ãƒ³ãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Bulgarian Split Squat',
          'ãƒ–ãƒ«ã‚¬ãƒªã‚¢ãƒ³ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Bulgarian Split Squat',
          'ãƒãƒ¼ãƒ™ãƒ«ãƒ»ãƒ•ãƒ­ãƒ³ãƒˆãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Barbell Front Squat',
          'ãƒãƒ¼ãƒ™ãƒ«ãƒ•ãƒ­ãƒ³ãƒˆã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Barbell Front Squat',
          'ãƒ•ãƒ­ãƒ³ãƒˆã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Front Squat',
          'ãƒãƒ¼ãƒ™ãƒ«ãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Barbell Squat',
          'ãƒãƒ¼ãƒ™ãƒ«ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Barbell Squat',
          'ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Squat',
          'ã‚´ãƒ–ãƒ¬ãƒƒãƒˆã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Goblet Squat',
          'ãƒãƒ³ã‚®ãƒ³ã‚°ãƒ»ãƒ‹ãƒ¼ãƒ¬ã‚¤ã‚º': 'Hanging Knee Raise',
          'ãƒãƒ³ã‚®ãƒ³ã‚°ãƒ‹ãƒ¼ãƒ¬ã‚¤ã‚º': 'Hanging Knee Raise',
          'ãƒ‹ãƒ¼ãƒ¬ã‚¤ã‚º': 'Knee Raise',
          'ã‚±ãƒ¼ãƒ–ãƒ«ãƒ»ã‚¦ãƒƒãƒ‰ãƒãƒ§ãƒƒãƒ—': 'Cable Wood Chop',
          'ã‚±ãƒ¼ãƒ–ãƒ«ã‚¦ãƒƒãƒ‰ãƒãƒ§ãƒƒãƒ—': 'Cable Wood Chop',
          'ã‚¦ãƒƒãƒ‰ãƒãƒ§ãƒƒãƒ—': 'Wood Chop',
          'ãƒãƒ³ãƒ‰ãƒ»ãƒ’ãƒƒãƒ—ã‚¢ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Hip Adduction Band',
          'ãƒ’ãƒƒãƒ—ã‚¢ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Hip Adduction',
          'ãƒ’ãƒƒãƒ—ãƒ»ã‚¢ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Hip Adduction',
          'ãƒãƒ³ãƒ‰ãƒ»ãƒ’ãƒƒãƒ—ã‚¢ãƒ–ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Hip Abduction Band',
          'ãƒ’ãƒƒãƒ—ã‚¢ãƒ–ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Hip Abduction',
          'ãƒ’ãƒƒãƒ—ãƒ»ã‚¢ãƒ–ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Hip Abduction',
          'è‚¡é–¢ç¯€ãƒãƒƒã‚¯ãƒ»ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³': 'Hip Extension',
          'ç‰‡è„šè‚¡é–¢ç¯€ãƒãƒƒã‚¯ãƒ»ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³': 'Single Leg Hip Extension',
          'ã‚«ãƒ¼ãƒ•ãƒ¬ã‚¤ã‚ºï¼ˆãƒ¬ãƒƒã‚°ãƒ—ãƒ¬ã‚¹ï¼‰': 'Leg Press Calf Raise',
          'ãƒ¬ãƒƒã‚°ãƒ—ãƒ¬ã‚¹': 'Leg Press',
          'ãƒ¬ãƒƒã‚°ãƒ»ãƒ—ãƒ¬ã‚¹': 'Leg Press',
          'ãƒ¬ãƒƒã‚°ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³': 'Leg Extension',
          'ãƒ¬ãƒƒã‚°ãƒ»ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³': 'Leg Extension',
          'ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«': 'Leg Curl',
          'ãƒ¬ãƒƒã‚°ãƒ»ã‚«ãƒ¼ãƒ«': 'Leg Curl',
          'ãƒ©ã‚¤ã‚¤ãƒ³ã‚°ãƒ»ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«': 'Lying Leg Curl',
          'ãƒ©ã‚¤ã‚¤ãƒ³ã‚°ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«': 'Lying Leg Curl',
          'ã‚·ãƒ¼ãƒ†ãƒƒãƒ‰ãƒ»ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«': 'Seated Leg Curl',
          'ã‚·ãƒ¼ãƒ†ãƒƒãƒ‰ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«': 'Seated Leg Curl',
          'ã‚¹ã‚¿ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ»ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«': 'Standing Leg Curl',
          'ã‚¹ã‚¿ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«': 'Standing Leg Curl'
        };
        
        const cleaned = japaneseText.replace(/[ï¼ˆ(].*?[)ï¼‰]/g, '').trim();
        if (dictionary[cleaned]) {
          console.log(`    ğŸ“– è¾æ›¸ãƒãƒƒãƒ: "${cleaned}" â†’ "${dictionary[cleaned]}"`);
          return dictionary[cleaned];
        }
        
        let translated = japaneseText;
        const partialDict = {
          'ã‚¹ãƒŸã‚¹': 'Smith Machine', 'ãƒãƒ¼ãƒ™ãƒ«': 'Barbell', 'ãƒ€ãƒ³ãƒ™ãƒ«': 'Dumbbell',
          'ãƒã‚·ãƒ³': 'Machine', 'ã‚±ãƒ¼ãƒ–ãƒ«': 'Cable', 'ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Squat',
          'ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ': 'Deadlift', 'ãƒ™ãƒ³ãƒ': 'Bench', 'ãƒ—ãƒ¬ã‚¹': 'Press',
          'ãƒ—ãƒ©ãƒ³ã‚¯': 'Plank', 'ã‚«ãƒ¼ãƒ«': 'Curl', 'ãƒ¬ã‚¤ã‚º': 'Raise',
          'ãƒ­ã‚¦': 'Row', 'ãƒ—ãƒ«': 'Pull', 'ãƒ—ãƒƒã‚·ãƒ¥': 'Push',
          'ãƒªãƒ•ãƒˆ': 'Lift', 'ã‚¹ãƒ©ã‚¹ãƒˆ': 'Thrust', 'ãƒ’ãƒƒãƒ—': 'Hip',
          'ãƒ¬ãƒƒã‚°': 'Leg', 'ã‚«ãƒ¼ãƒ•': 'Calf', 'ãƒ•ãƒ­ãƒ³ãƒˆ': 'Front',
          'ã‚µã‚¤ãƒ‰': 'Side', 'ãƒãƒƒã‚¯': 'Back', 'ãƒ«ãƒ¼ãƒãƒ‹ã‚¢ãƒ³': 'Romanian',
          'ãƒ–ãƒ«ã‚¬ãƒªã‚¢ãƒ³': 'Bulgarian', 'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯': 'Nordic',
          'ç‰‡è„š': 'Single Leg', 'ä¸¡è„š': 'Double Leg', 'è‡ªé‡': 'Bodyweight',
          'ãƒãƒ³ã‚®ãƒ³ã‚°': 'Hanging', 'ãƒ‹ãƒ¼': 'Knee', 'ã‚¦ãƒƒãƒ‰': 'Wood',
          'ãƒãƒ§ãƒƒãƒ—': 'Chop', 'ãƒãƒ³ãƒ‰': 'Band', 'ã‚¢ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Adduction',
          'ã‚¢ãƒ–ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Abduction', 'ãƒ„ã‚¤ã‚¹ãƒˆ': 'Twist',
          'ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚¹': 'Hamstring', 'ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°': 'Hamstring', 'ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚¹': 'Hamstring'
        };
        
        for (const [jp, en] of Object.entries(partialDict)) {
          translated = translated.replace(new RegExp(jp, 'g'), en);
        }
        
        return translated.replace(/[ãƒ»ã€ã€‚]/g, ' ').replace(/\s+/g, ' ').trim();
      };
      
      const translatedName = translateToEnglish(exerciseName);
      const searchKeywords = translatedName.toLowerCase().split(/[\s\-]+/).filter(w => w.length >= 1);
      
      const candidates = allTemplates.filter(t => {
        const titleLower = t.title.toLowerCase();
        return searchKeywords.some(keyword => titleLower.includes(keyword));
      });
      
      const scoredTemplates = candidates.map(t => ({
        template: t,
        score: 500,
        reason: 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´',
        title: t.title
      }));
      
      // å…¨å€™è£œã‚’è¡¨ç¤ºï¼ˆæœ€å¤§50ä»¶ï¼‰
      showInlineSuggestions(exNode, exerciseName, scoredTemplates.slice(0, 50));
    }
    
    function completeStep2() {
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      const title = document.getElementById('title').value.trim();
      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;
      const exercises = exList.querySelectorAll('.exercise');
      
      if (!title) {
        alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      if (!startTime || !endTime) {
        alert('é–‹å§‹æ—¥æ™‚ã¨çµ‚äº†æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      if (exercises.length === 0) {
        alert('æœ€ä½1ã¤ã®ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
        return;
      }
      
      updateStepStatus('step2Card', 'complete');
      updateStepStatus('step3Card', 'active');
      goToStep(3);
      refreshPreview();
    }
    
    // ã‚¹ãƒ†ãƒƒãƒ—3: å†…å®¹ç¢ºèª
    function collectPayload() {
      const title = document.getElementById('title').value.trim();
      const description = document.getElementById('description').value.trim();
      const start = document.getElementById('startTime').value;
      const end = document.getElementById('endTime').value;
      const startISO = toISO(start);
      const endISO = toISO(end);
      const isPrivate = document.getElementById('isPrivate').checked;
      
      const exercises = [...exList.querySelectorAll('.exercise')].map(ex => {
        const tplId = ex.querySelector('.tplId').value.trim();
        const note = ex.querySelector('.exNote').value.trim();
        const sets = [...ex.querySelectorAll('.set')].map(s => {
          const type = s.querySelector('.type').value.trim() || 'normal';
          const w = s.querySelector('.w').value;
          const r = s.querySelector('.r').value;
          const dur = s.querySelector('.dur').value;
          const dist = s.querySelector('.dist').value;
          const rpe = s.querySelector('.rpe').value;
          return {
            type,
            weight_kg: w !== '' ? parseFloat(w) : null,
            reps: r !== '' ? parseInt(r, 10) : null,
            distance_meters: dist !== '' ? parseFloat(dist) : null,
            duration_seconds: dur !== '' ? parseInt(dur, 10) : null,
            custom_metric: null,
            rpe: rpe !== '' ? parseFloat(rpe) : null
          };
        }).filter(set => !(set.weight_kg===null && set.reps===null && set.duration_seconds===null && set.distance_meters===null));
        
        return { exercise_template_id: tplId, notes: note, sets };
      }).filter(ex => ex.sets.length > 0);
      
      return {
        workout: { 
          title, 
          description: description || null,  // ğŸ‘ ç©ºæ–‡å­—åˆ—ã®å ´åˆã¯nullã«å¤‰æ›
          start_time: startISO, 
          end_time: endISO, 
          is_private: isPrivate, 
          exercises 
        }
      };
    }
    
    function validate(payload) {
      const e = [];
      const w = payload.workout;
      if(!w.title) e.push('ã‚¿ã‚¤ãƒˆãƒ«ãŒæœªå…¥åŠ›ã§ã™');
      if(!w.start_time || !w.end_time) e.push('é–‹å§‹/çµ‚äº†ã®ã„ãšã‚Œã‹ãŒæœªå…¥åŠ›ã§ã™');
      if(w.start_time && w.end_time && new Date(w.start_time) >= new Date(w.end_time)) e.push('é–‹å§‹ã¯çµ‚äº†ã‚ˆã‚Šå‰ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
      if(!w.exercises || w.exercises.length===0) e.push('æœ€ä½1ã¤ã®ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºï¼ˆ1ã‚»ãƒƒãƒˆä»¥ä¸Šï¼‰ãŒå¿…è¦ã§ã™');
      for(let i=0;i<(w.exercises||[]).length;i++){
        if(!w.exercises[i].exercise_template_id) e.push(`ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚º${i+1}: ãƒ†ãƒ³ãƒ—ãƒ¬IDãŒæœªå…¥åŠ›ã§ã™`);
      }
      return e;
    }
    
    function refreshPreview() {
      const payload = collectPayload();
      const errs = validate(payload);
      const preview = document.getElementById('preview');
      preview.textContent = JSON.stringify(payload, null, 2);
      
      const validationResult = document.getElementById('validationResult');
      if (errs.length > 0) {
        validationResult.innerHTML = `<div class="tips" style="border-left-color: var(--danger);"><p class="err" style="margin: 0;"><strong>âš ï¸ æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ:</strong></p><ul style="margin: 8px 0 0; padding-left: 20px;">${errs.map(e => `<li>${e}</li>`).join('')}</ul></div>`;
        document.getElementById('submitBtn').disabled = true;
      } else {
        validationResult.innerHTML = `<div class="success-box"><p class="ok" style="margin: 0;">âœ“ é€ä¿¡å¯èƒ½ãªçŠ¶æ…‹ã§ã™</p></div>`;
        document.getElementById('submitBtn').disabled = false;
      }
    }
    
    // ğŸ’ ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å€™è£œè¡¨ç¤ºæ©Ÿèƒ½
    function showInlineSuggestions(exNode, japaneseName, candidates) {
      const container = exNode.querySelector('.inline-suggestions-container');
      if (!container || candidates.length === 0) return;
      
      const exerciseName = exNode.dataset.exerciseName || japaneseName;
      
      const html = `
        <div class="inline-suggestions">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <p style="margin: 0; font-size: 0.8rem; color: var(--muted);">ğŸ’¡ è¿‘ä¼¼å€™è£œï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é¸æŠï¼‰ï¼š</p>
            <button class="btn ghost" style="padding: 4px 10px; font-size: 0.8rem;" onclick="event.stopPropagation(); searchInlineExpanded(this.closest('.exercise'))">ğŸ” ã‚‚ã£ã¨æ¤œç´¢</button>
          </div>
          ${candidates.map(c => `
            <div class="inline-suggestion-item" onclick="selectInlineSuggestion(this, '${exerciseName}', '${c.template.id}', '${c.template.title.replace(/'/g, "\\'")}')">
              <div style="flex: 1;">
                <div style="font-weight: 600;">${c.template.title}</div>
                <div style="font-size: 0.75rem; color: var(--muted); margin-top: 2px;">ID: ${c.template.id} | ${c.score}ç‚¹ - ${c.reason}</div>
              </div>
              <button class="btn ghost" style="padding: 4px 8px; font-size: 0.75rem; flex-shrink: 0;" onclick="event.stopPropagation(); copyToClipboard('${c.template.id}')">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
            </div>
          `).join('')}
        </div>
      `;
      container.innerHTML = html;
    }
    
    function selectInlineSuggestion(element, japaneseName, templateId, templateTitle) {
      const exNode = element.closest('.exercise');
      const tplIdInput = exNode.querySelector('.tplId');
      tplIdInput.value = templateId;
      tplIdInput.style.borderColor = '#15c27a';
      tplIdInput.style.background = '#0a2a1a';
      
      // ğŸ§  å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«ä¿å­˜
      saveLearnedMapping(japaneseName, templateId, templateTitle);
      
      // å€™è£œãƒªã‚¹ãƒˆã‚’å‰Šé™¤
      const container = exNode.querySelector('.inline-suggestions-container');
      if (container) {
        container.innerHTML = `<p style="color: var(--ok); font-size: 0.85rem; margin: 8px 0;">âœ… é¸æŠå®Œäº† - æ¬¡å›ã‹ã‚‰è‡ªå‹•çš„ã«é©ç”¨ã•ã‚Œã¾ã™ ğŸ§ </p>`;
      }
    }
    
    // ğŸ” ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æ¤œç´¢æ©Ÿèƒ½ï¼ˆæ‹¡å¼µç‰ˆãƒ»ã€Œã‚‚ã£ã¨æ¤œç´¢ã€ç”¨ï¼‰
    function searchInlineExpanded(exNode) {
      const exerciseName = exNode.dataset.exerciseName || '';
      
      if (!exerciseName || allTemplates.length === 0) {
        alert('ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºåãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ã‹ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒå–å¾—ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
      
      // ç¿»è¨³è¾æ›¸ã‚’ä½¿ç”¨
      const translateToEnglish = (text) => {
        const dictionary = {
          'ãƒãƒ³ã‚®ãƒ³ã‚°ãƒ»ãƒ‹ãƒ¼ãƒ¬ã‚¤ã‚º': 'Hanging Knee Raise',
          'ã‚±ãƒ¼ãƒ–ãƒ«ãƒ»ã‚¦ãƒƒãƒ‰ãƒãƒ§ãƒƒãƒ—': 'Cable Wood Chop',
          'ãƒãƒ³ãƒ‰ãƒ»ãƒ’ãƒƒãƒ—ã‚¢ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Hip Adduction Band',
          'ãƒãƒ³ãƒ‰ãƒ»ãƒ’ãƒƒãƒ—ã‚¢ãƒ–ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Hip Abduction Band'
        };
        
        if (dictionary[text]) return dictionary[text];
        
        let translated = text;
        const partialDict = {
          'ãƒãƒ³ã‚®ãƒ³ã‚°': 'Hanging', 'ãƒ‹ãƒ¼': 'Knee', 'ãƒ¬ã‚¤ã‚º': 'Raise',
          'ã‚±ãƒ¼ãƒ–ãƒ«': 'Cable', 'ã‚¦ãƒƒãƒ‰': 'Wood', 'ãƒãƒ§ãƒƒãƒ—': 'Chop',
          'ãƒãƒ³ãƒ‰': 'Band', 'ãƒ’ãƒƒãƒ—': 'Hip', 'ã‚¢ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Adduction',
          'ã‚¢ãƒ–ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Abduction'
        };
        
        for (const [jp, en] of Object.entries(partialDict)) {
          translated = translated.replace(new RegExp(jp, 'g'), en);
        }
        
        return translated.replace(/[ãƒ»ã€ã€‚]/g, ' ').replace(/\s+/g, ' ').trim();
      };
      
      const translatedName = translateToEnglish(exerciseName);
      const searchKeywords = translatedName.toLowerCase().split(/[\s\-]+/).filter(w => w.length >= 2);
      
      console.log(`ğŸ” æ‹¡å¼µæ¤œç´¢: "${exerciseName}" â†’ "${translatedName}"`);
      console.log(`   ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: [${searchKeywords.join(', ')}]`);
      
      // ã‚ˆã‚ŠæŸ”è»Ÿãªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const candidates = allTemplates
        .filter(t => {
          const titleLower = t.title.toLowerCase();
          return searchKeywords.some(keyword => titleLower.includes(keyword));
        })
        .map(t => ({ template: t, score: 500, reason: 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´', title: t.title }))
        .slice(0, 30); // ãƒˆãƒƒãƒ—30å€™è£œ
      
      if (candidates.length === 0) {
        alert('å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        return;
      }
      
      console.log(`   â†’ ${candidates.length}ä»¶ã®å€™è£œã‚’ç™ºè¦‹`);
      showInlineSuggestions(exNode, exerciseName, candidates);
    }
    
    // ğŸ” ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æ¤œç´¢æ©Ÿèƒ½ï¼ˆé€šå¸¸ç‰ˆï¼‰
    function searchInline(button) {
      const exNode = button.closest('.exercise');
      const exerciseName = exNode.dataset.exerciseName || '';
      
      if (!exerciseName) {
        alert('ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºåãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
      
      if (allTemplates.length === 0) {
        alert('å…ˆã«APIã‚­ãƒ¼ã®æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
        return;
      }
      
      // ç¿»è¨³è¾æ›¸ã‚’ä½¿ã£ã¦æ¤œç´¢ï¼ˆå®Œå…¨ç‰ˆï¼‰
      const translateToEnglish = (text) => {
        const dictionary = {
          'ã‚¹ãƒŸã‚¹ãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Smith Machine Squat',
          'ãƒ«ãƒ¼ãƒãƒ‹ã‚¢ãƒ³ãƒ»ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ': 'Romanian Deadlift',
          'ãƒ’ãƒƒãƒ—ã‚¹ãƒ©ã‚¹ãƒˆ': 'Hip Thrust',
          'ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯ãƒ»ãƒãƒ ': 'Nordic Hamstring Curl',
          'ã‚µã‚¤ãƒ‰ãƒ»ãƒ’ãƒƒãƒ—ãƒªãƒ•ãƒˆ': 'Side Hip Raise',
          'ç‰‡è„šã‚«ãƒ¼ãƒ•ãƒ¬ã‚¤ã‚º': 'Single Leg Calf Raise',
          'ã‚«ãƒ¼ãƒ•ãƒ¬ã‚¤ã‚º': 'Calf Raise',
          'ãƒ•ãƒ­ãƒ³ãƒˆãƒ»ãƒ—ãƒ©ãƒ³ã‚¯': 'Front Plank',
          'ãƒ—ãƒ©ãƒ³ã‚¯': 'Plank',
          'ãƒ–ãƒ«ã‚¬ãƒªã‚¢ãƒ³ãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Bulgarian Split Squat',
          'ãƒãƒ¼ãƒ™ãƒ«ãƒ»ãƒ•ãƒ­ãƒ³ãƒˆãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Barbell Front Squat',
          'ãƒãƒ¼ãƒ™ãƒ«ãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Barbell Squat',
          'ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ': 'Squat',
          'ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹': 'Bench Press',
          'ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ': 'Deadlift',
          'ãƒãƒ³ã‚®ãƒ³ã‚°ãƒ»ãƒ‹ãƒ¼ãƒ¬ã‚¤ã‚º': 'Hanging Knee Raise',
          'ã‚±ãƒ¼ãƒ–ãƒ«ãƒ»ã‚¦ãƒƒãƒ‰ãƒãƒ§ãƒƒãƒ—': 'Cable Wood Chop',
          'ãƒãƒ³ãƒ‰ãƒ»ãƒ’ãƒƒãƒ—ã‚¢ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Hip Adduction Band',
          'ãƒãƒ³ãƒ‰ãƒ»ãƒ’ãƒƒãƒ—ã‚¢ãƒ–ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Hip Abduction Band'
        };
        
        // è¾æ›¸ã«ãªã„å ´åˆã¯éƒ¨åˆ†ç¿»è¨³ã‚’è©¦ã¿ã‚‹
        if (dictionary[text]) return dictionary[text];
        
        let translated = text;
        const partialDict = {
          'ãƒãƒ³ã‚®ãƒ³ã‚°': 'Hanging', 'ãƒ‹ãƒ¼': 'Knee', 'ãƒ¬ã‚¤ã‚º': 'Raise',
          'ã‚±ãƒ¼ãƒ–ãƒ«': 'Cable', 'ã‚¦ãƒƒãƒ‰': 'Wood', 'ãƒãƒ§ãƒƒãƒ—': 'Chop',
          'ãƒãƒ³ãƒ‰': 'Band', 'ãƒ’ãƒƒãƒ—': 'Hip', 'ã‚¢ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Adduction',
          'ã‚¢ãƒ–ãƒ€ã‚¯ã‚·ãƒ§ãƒ³': 'Abduction', 'ãƒãƒ¼ãƒ™ãƒ«': 'Barbell', 'ãƒ€ãƒ³ãƒ™ãƒ«': 'Dumbbell'
        };
        
        for (const [jp, en] of Object.entries(partialDict)) {
          translated = translated.replace(new RegExp(jp, 'g'), en);
        }
        
        return translated.replace(/[ãƒ»ã€ã€‚]/g, ' ').replace(/\s+/g, ' ').trim();
      };
      
      const translatedName = translateToEnglish(exerciseName);
      const searchKeywords = translatedName.toLowerCase().split(/[\s\-]+/).filter(w => w.length >= 2);
      
      console.log(`ğŸ” ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æ¤œç´¢: "${exerciseName}" â†’ "${translatedName}"`);
      console.log(`   ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: [${searchKeywords.join(', ')}]`);
      
      // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼†ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
      const calculateSimpleScore = (translatedName, templateTitle) => {
        const translatedLower = translatedName.toLowerCase();
        const titleLower = templateTitle.toLowerCase();
        
        // å®Œå…¨ä¸€è‡´
        if (titleLower === translatedLower) return { score: 1000, reason: 'å®Œå…¨ä¸€è‡´' };
        
        // æ­£è¦åŒ–ã—ã¦å®Œå…¨ä¸€è‡´
        const normalizedTitle = templateTitle.replace(/[ï¼ˆ(].*?[)ï¼‰]/g, '').toLowerCase().replace(/[\s\-]/g, '');
        const normalizedSearch = translatedName.replace(/[ï¼ˆ(].*?[)ï¼‰]/g, '').toLowerCase().replace(/[\s\-]/g, '');
        if (normalizedTitle === normalizedSearch) return { score: 950, reason: 'æ­£è¦åŒ–ä¸€è‡´' };
        
        // éƒ¨åˆ†ä¸€è‡´
        if (titleLower.includes(translatedLower) || translatedLower.includes(titleLower)) {
          return { score: 800, reason: 'éƒ¨åˆ†ä¸€è‡´' };
        }
        
        // å˜èªãƒ¬ãƒ™ãƒ«ã®ä¸€è‡´
        const translatedWords = translatedName.toLowerCase().split(/[\s\-]+/).filter(w => w.length >= 3);
        const titleWords = templateTitle.toLowerCase().split(/[\s\-]+/).filter(w => w.length >= 3);
        const matches = translatedWords.filter(w => titleWords.some(tw => tw.includes(w) || w.includes(tw)));
        
        if (matches.length > 0) {
          const ratio = matches.length / translatedWords.length;
          return { score: Math.floor(600 * ratio), reason: `å˜èªä¸€è‡´(${matches.length}/${translatedWords.length})` };
        }
        
        return { score: 300, reason: 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´' };
      };
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼†ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
      const candidates = allTemplates
        .filter(t => {
          const titleLower = t.title.toLowerCase();
          return searchKeywords.some(keyword => titleLower.includes(keyword));
        })
        .map(t => {
          const scoreData = calculateSimpleScore(translatedName, t.title);
          return {
            template: t,
            score: scoreData.score,
            reason: scoreData.reason,
            title: t.title
          };
        })
        .sort((a, b) => b.score - a.score)
        .slice(0, 20); // ãƒˆãƒƒãƒ—20å€™è£œ
      
      if (candidates.length === 0) {
        alert('å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\nåˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§è©¦ã™ã‹ã€ã€ŒğŸ“‹ ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºä¸€è¦§ã€ã‹ã‚‰ç›´æ¥æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      
      console.log(`   â†’ ${candidates.length}ä»¶ã®å€™è£œã‚’ç™ºè¦‹`);
      showInlineSuggestions(exNode, exerciseName, candidates);
    }
    
    // ã‚¹ãƒ†ãƒƒãƒ—4: ç™»éŒ²å®Ÿè¡Œ
    async function submitWorkout() {
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = 'é€ä¿¡ä¸­...';
      
      const apiKey = document.getElementById('apiKey').value.trim();
      const payload = collectPayload();
      const responseArea = document.getElementById('responseArea');
      
      try {
        const r = await fetch('https://api.hevyapp.com/v1/workouts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'api-key': apiKey },
          body: JSON.stringify(payload)
        });
        const text = await r.text();
        let body; try{ body = JSON.parse(text); } catch{ body = { raw:text }; }
        
        if (r.status === 201) {
          // ğŸ§  ç™»éŒ²æˆåŠŸæ™‚ï¼šä½¿ç”¨ã—ãŸãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«ä¿å­˜
          const exercises = exList.querySelectorAll('.exercise');
          exercises.forEach(exNode => {
            const exerciseName = exNode.dataset.exerciseName;
            const tplId = exNode.querySelector('.tplId').value.trim();
            if (exerciseName && tplId) {
              const template = allTemplates.find(t => t.id === tplId);
              if (template) {
                saveLearnedMapping(exerciseName, tplId, template.title);
              }
            }
          });
          
          responseArea.innerHTML = `
            <div class="success-box">
              <h3 style="margin: 0 0 12px; color: var(--ok);">ğŸ‰ ç™»éŒ²æˆåŠŸï¼</h3>
              <p style="margin: 0 0 8px;">ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆãŒHEVYã«ç™»éŒ²ã•ã‚Œã¾ã—ãŸã€‚ã‚¢ãƒ—ãƒªã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
              <p style="margin: 0; font-size: 0.85rem; color: var(--muted);">ğŸ§  ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å­¦ç¿’ã—ã¾ã—ãŸã€‚æ¬¡å›ã‹ã‚‰è‡ªå‹•çš„ã«é©ç”¨ã•ã‚Œã¾ã™ã€‚</p>
            </div>
            <details style="margin-top: 16px;">
              <summary style="cursor: pointer; color: var(--acc);">ğŸ“„ ãƒ¬ã‚¹ãƒãƒ³ã‚¹è©³ç´°</summary>
              <pre style="margin-top: 12px;">${JSON.stringify(body, null, 2)}</pre>
            </details>
          `;
          updateStepStatus('step4Card', 'complete');
          document.getElementById('resetBtn').style.display = 'block';
        } else {
          responseArea.innerHTML = `
            <div class="tips" style="border-left-color: var(--danger);">
              <h3 style="margin: 0 0 12px; color: var(--danger);">âŒ ç™»éŒ²å¤±æ•—</h3>
              <p style="margin: 0 0 8px;"><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰:</strong> ${r.status}</p>
              <p style="margin: 0;"><strong>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong> ${r.statusText}</p>
            </div>
            <pre style="margin-top: 16px;">${JSON.stringify(body, null, 2)}</pre>
          `;
          btn.disabled = false;
          btn.textContent = 'ğŸ“¤ å†è©¦è¡Œ';
        }
        
        updateStepStatus('step3Card', 'complete');
        updateStepStatus('step4Card', 'active');
        goToStep(4);
        
      } catch (e) {
        responseArea.innerHTML = `
          <div class="tips" style="border-left-color: var(--danger);">
            <h3 style="margin: 0 0 12px; color: var(--danger);">âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼</h3>
            <p style="margin: 0;">${e.message}</p>
          </div>
        `;
        btn.disabled = false;
        btn.textContent = 'ğŸ“¤ å†è©¦è¡Œ';
      }
    }
    
    function resetAll() {
      if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¦æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ')) {
        location.reload();
      }
    }
    
    // ğŸ§  å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ç®¡ç†
    function showLearningModal() {
      const modal = document.getElementById('learningModal');
      const listDiv = document.getElementById('learningDataList');
      modal.classList.add('show');
      
      const mappings = getLearnedMappings();
      const entries = Object.entries(mappings).sort((a, b) => b[1].lastUsed - a[1].lastUsed);
      
      if (entries.length === 0) {
        listDiv.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 40px;">ã¾ã å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }
      
      listDiv.innerHTML = `
        <table class="template-table">
          <thead>
            <tr>
              <th>æ—¥æœ¬èªå</th>
              <th>ãƒãƒƒãƒãƒ³ã‚°å…ˆ</th>
              <th style="width:120px;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆID</th>
              <th style="width:80px;">ä½¿ç”¨å›æ•°</th>
              <th style="width:100px;">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
            </tr>
          </thead>
          <tbody>
            ${entries.map(([jpName, data]) => `
              <tr>
                <td><strong>${jpName}</strong></td>
                <td>${data.title}</td>
                <td><code style="font-size: 0.85rem;">${data.id}</code></td>
                <td style="text-align: center;">${data.count}å›</td>
                <td style="text-align: center;">
                  <button class="btn" style="background: var(--danger); border-color: var(--danger); padding: 6px 12px; font-size: 0.85rem;" 
                          onclick="deleteLearningData('${jpName}')">å‰Šé™¤</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }
    
    function deleteLearningData(japaneseName) {
      if (!confirm(`ã€Œ${japaneseName}ã€ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      
      const mappings = getLearnedMappings();
      const normalized = japaneseName.toLowerCase().trim();
      delete mappings[normalized];
      localStorage.setItem(LEARNING_STORAGE_KEY, JSON.stringify(mappings));
      
      showLearningModal(); // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
    }
    
    function clearAllLearningData() {
      if (!confirm('ã™ã¹ã¦ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
      
      localStorage.removeItem(LEARNING_STORAGE_KEY);
      showLearningModal(); // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
    function showTemplatesModal() {
      const modal = document.getElementById('templatesModal');
      const tbody = document.getElementById('templateTableBody');
      modal.classList.add('show');
      
      if (allTemplates.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#ff5566;">âš ï¸ å…ˆã«APIã‚­ãƒ¼ã®æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„</td></tr>';
        return;
      }
      
      renderTemplateTable(allTemplates);
    }
    
    function renderTemplateTable(templates) {
      const tbody = document.getElementById('templateTableBody');
      const favorites = getFavorites();
      
      tbody.innerHTML = templates.map(t => `
        <tr>
          <td>
            <span class="favorite-star ${favorites[t.id] ? 'active' : ''}" 
                  data-id="${t.id}" 
                  data-title="${t.title}"
                  onclick="toggleFavorite('${t.id}', '${t.title.replace(/'/g, "\\'")}', this)">
              ${favorites[t.id] ? 'â˜…' : 'â˜†'}
            </span>
          </td>
          <td>${t.title}</td>
          <td><code style="font-size:0.85rem;">${t.id}</code></td>
          <td>
            <button class="copy-id-btn" onclick="copyToClipboard('${t.id}', this)">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
          </td>
        </tr>
      `).join('');
    }
    
    function filterTemplates() {
      const query = document.getElementById('templateSearch').value.toLowerCase();
      const filtered = allTemplates.filter(t => t.title.toLowerCase().includes(query));
      renderTemplateTable(filtered);
    }
    
    function showFavoritesModal() {
      const modal = document.getElementById('favoritesModal');
      const list = document.getElementById('favoritesList');
      const favorites = getFavorites();
      
      if (Object.keys(favorites).length === 0) {
        list.innerHTML = '<p style="color: var(--muted); text-align:center; padding:40px;">ãŠæ°—ã«å…¥ã‚ŠãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºä¸€è¦§ã‹ã‚‰â­ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>';
      } else {
        list.innerHTML = Object.entries(favorites).map(([id, title]) => `
          <div style="background: #0e141b; border: 1px solid #1e2a36; padding: 16px; border-radius: 10px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>${title}</strong><br>
              <code style="font-size:0.85rem; color:#a9b6c6;">${id}</code>
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn" onclick="copyToClipboard('${id}', this)">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
              <button class="btn" style="background: var(--danger); border-color: var(--danger);" onclick="removeFavorite('${id}')">å‰Šé™¤</button>
            </div>
          </div>
        `).join('');
      }
      
      modal.classList.add('show');
    }
    
    // ãŠæ°—ã«å…¥ã‚Šç®¡ç†
    function getFavorites() {
      return JSON.parse(localStorage.getItem('hevyFavorites') || '{}');
    }
    
    function saveFavorites(favs) {
      localStorage.setItem('hevyFavorites', JSON.stringify(favs));
    }
    
    function toggleFavorite(id, title, element) {
      const favs = getFavorites();
      const isActive = favs[id];
      
      if (isActive) {
        delete favs[id];
        element.textContent = 'â˜†';
        element.classList.remove('active');
      } else {
        favs[id] = title;
        element.textContent = 'â˜…';
        element.classList.add('active');
      }
      
      saveFavorites(favs);
    }
    
    function removeFavorite(id) {
      const favs = getFavorites();
      delete favs[id];
      saveFavorites(favs);
      showFavoritesModal(); // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
    }
    
    function copyToClipboard(text, button) {
      navigator.clipboard.writeText(text);
      const originalText = button.textContent;
      button.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼æ¸ˆã¿';
      setTimeout(() => button.textContent = originalText, 2000);
    }
    
    // åˆæœŸåŒ–ï¼ˆDOMãƒ­ãƒ¼ãƒ‰å¾Œã«å®Ÿè¡Œï¼‰
    // ğŸ§  åˆæœŸå­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®è¨­å®š
    function initializeDefaultLearning() {
      const mappings = getLearnedMappings();
      
      // åˆæœŸå­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒãƒ”ãƒ³ã‚°
      const defaultMappings = [
        // ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆç³»
        { names: ['ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ', 'ãƒãƒ¼ãƒ™ãƒ«ãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ', 'ãƒãƒ¼ãƒ™ãƒ«ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ', 'ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆãƒãƒ¼ãƒ™ãƒ«'], id: 'D04AC939', title: 'Barbell Squat' },
        // ã‚°ãƒƒãƒ‰ãƒ»ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°
        { names: ['ã‚°ãƒƒãƒ‰ãƒ»ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°', 'ã‚°ãƒƒãƒ‰ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°'], id: '4180C405', title: 'Good Morning' },
        // ãƒ‡ã‚¯ãƒ©ã‚¤ãƒ³ãƒ»ãƒ¬ãƒƒã‚°ãƒ¬ã‚¤ã‚ºï¼ˆLying Leg Raiseã¨ã—ã¦ç™»éŒ²ï¼‰
        { names: ['ãƒ‡ã‚¯ãƒ©ã‚¤ãƒ³ãƒ»ãƒ¬ãƒƒã‚°ãƒ¬ã‚¤ã‚º', 'ãƒ‡ã‚¯ãƒ©ã‚¤ãƒ³ãƒ¬ãƒƒã‚°ãƒ¬ã‚¤ã‚º'], id: '09C9F635', title: 'Lying Leg Raise' },
        // ãƒã‚¤ã‚»ãƒ—ã‚¹ãƒ»ãƒãƒ³ã‚¢ãƒƒãƒ—ï¼ˆChin Upã¨ã—ã¦ç™»éŒ²ï¼‰
        { names: ['ãƒã‚¤ã‚»ãƒ—ã‚¹ãƒ»ãƒãƒ³ã‚¢ãƒƒãƒ—', 'ãƒã‚¤ã‚»ãƒ—ã‚¹ãƒãƒ³ã‚¢ãƒƒãƒ—', 'ãƒãƒ³ã‚¢ãƒƒãƒ—'], id: '29083183', title: 'Chin Up' }
      ];
      
      let addedCount = 0;
      defaultMappings.forEach(mapping => {
        mapping.names.forEach(variant => {
          const normalized = variant.toLowerCase().trim();
          if (!mappings[normalized]) {
            mappings[normalized] = {
              id: mapping.id,
              title: mapping.title,
              count: 1,
              lastUsed: Date.now()
            };
            addedCount++;
          }
        });
      });
      
      if (addedCount > 0) {
        try {
          localStorage.setItem(LEARNING_STORAGE_KEY, JSON.stringify(mappings));
          console.log(`ğŸ§  åˆæœŸå­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¾ã—ãŸ (${addedCount}ä»¶ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³)`);
        } catch (e) {
          console.error('åˆæœŸå­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
        }
      }
    }
    
    window.addEventListener('DOMContentLoaded', () => {
      console.log('ğŸš€ HEVY Workout Tool v6.3 - æœªæ¥ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç™»éŒ²å¯¾å¿œ');
      
      // ğŸ§  åˆæœŸå­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
      initializeDefaultLearning();
      console.log('ğŸ“ å¯¾å¿œå½¢å¼:');
      console.log('  âœ… å¾“æ¥å½¢å¼ï¼ˆã‚³ãƒ­ãƒ³åŒºåˆ‡ã‚Šï¼‰');
      console.log('  âœ… HEVYã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå½¢å¼ï¼ˆç•ªå·ä»˜ããƒ»bullet pointï¼‰');
      console.log('  âœ… æ—¥æœ¬èªæ—¥ä»˜ï¼ˆ8æœˆ29æ—¥ï¼‰');
      console.log('  âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ™‚åˆ»: 9:00-10:30');
      
      // ğŸ”’ APIã‚­ãƒ¼ã‚’è‡ªå‹•å¾©å…ƒ
      const hasApiKey = loadApiKey();
      if (hasApiKey) {
        console.log('âœ… ä¿å­˜æ¸ˆã¿APIã‚­ãƒ¼ã‚’è‡ªå‹•å¾©å…ƒã—ã¾ã—ãŸ');
      } else {
        console.log('â„¹ï¸ ä¿å­˜æ¸ˆã¿APIã‚­ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚åˆå›å…¥åŠ›å¾Œã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚');
      }
      
      // ğŸ“¦ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è‡ªå‹•å¾©å…ƒ
      const savedData = loadTemplates();
      if (savedData) {
        allTemplates = savedData.templates;
        const savedDate = new Date(savedData.timestamp);
        const resultDiv = document.getElementById('apiTestResult');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `<div class="success-box">
          <p class="ok" style="margin: 0 0 8px;">âœ… ä¿å­˜æ¸ˆã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ ${allTemplates.length}ä»¶ã‚’å¾©å…ƒã—ã¾ã—ãŸ</p>
          <p style="font-size: 0.85rem; color: var(--muted); margin: 4px 0 0;">ğŸ“¦ å–å¾—æ—¥æ™‚: ${savedDate.toLocaleString('ja-JP')}</p>
          <p style="font-size: 0.75rem; color: var(--muted); margin: 8px 0 0;">ğŸ’¡ æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã«æ›´æ–°ã™ã‚‹å ´åˆã¯ã€ŒğŸ”„ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å†å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
        </div>`;
        document.getElementById('step1NextBtn').disabled = false;
        console.log('âœ… ä¿å­˜æ¸ˆã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è‡ªå‹•å¾©å…ƒã—ã¾ã—ãŸ');
      } else {
        console.log('â„¹ï¸ ä¿å­˜æ¸ˆã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚åˆå›APIæ¥ç¶šæ™‚ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚');
      }
      
      // ğŸ“… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ™‚åˆ»ã®è¨­å®šï¼ˆæ™‚åˆ»ãŒç©ºã®å ´åˆã®ã¿ï¼‰
      const startTimeInput = document.getElementById('startTime');
      const endTimeInput = document.getElementById('endTime');
      
      if (!startTimeInput.value) {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        startTimeInput.value = `${year}-${month}-${day}T09:00`;
        endTimeInput.value = `${year}-${month}-${day}T10:30`;
        console.log('ğŸ“… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ™‚åˆ»ã‚’è¨­å®šã—ã¾ã—ãŸ: 9:00-10:30');
      }
    });
  </script>
</body>
</html>
